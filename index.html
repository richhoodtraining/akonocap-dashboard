<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Akonocap Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f0f2f5;
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      --border-subtle: #dadde1;
      --text-main: #050505;
      --text-muted: #606770;
      --accent: #1877f2;
      --accent-soft: rgba(24, 119, 242, 0.1);
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-strong: 0 12px 30px rgba(0, 0, 0, 0.12);
      --pill-bg: #e4e6eb;
      --overlay: rgba(255, 255, 255, 0.7);
      --success: #16a34a;
      --warning: #f59e0b;
    }

    body.theme-dark {
      --bg: #050816;
      --bg-card: #111827;
      --bg-header: #020617;
      --border-subtle: #1f2933;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --accent: #1d9bf0;
      --accent-soft: rgba(29, 155, 240, 0.12);
      --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 18px 40px rgba(0, 0, 0, 0.7);
      --pill-bg: #1f2937;
      --overlay: rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e3ebff 0, #f0f2f5 40%, var(--bg) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    body.theme-dark {
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #020617 100%);
    }

    .shell {
      width: 100%;
      max-width: 1400px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px 12px 24px;
    }

    /* Header */
    header {
      padding: 12px 18px;
      border-radius: 14px;
      background: var(--bg-header);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-pill {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #1877f2, #42b72a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9);
    }

    .app-name {
      font-size: 20px;
      font-weight: 600;
    }

    .tagline {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Buttons */
    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 3px 8px rgba(24, 119, 242, 0.35);
      font-weight: 600;
    }

    .btn-primary:hover {
      background: #1664d8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--accent);
      border: 1px solid rgba(24, 119, 242, 0.35);
    }

    body.theme-dark .btn-secondary {
      background: #020617;
      color: var(--accent);
      border-color: rgba(148, 163, 184, 0.6);
    }

    .btn-secondary:hover {
      background: var(--accent-soft);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      font-size: 12px;
      padding: 6px 12px;
    }

    .btn-ghost:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .btn-success {
      background: var(--success);
      color: #ffffff;
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    /* Theme toggle */
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f5f6f7;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
    }

    body.theme-dark .theme-toggle {
      background: #020617;
    }

    /* User info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-4px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .user-info.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      object-fit: cover;
      border: 2px solid var(--accent);
    }

    .user-name {
      font-size: 13px;
      font-weight: 500;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .user-id {
      font-size: 11px;
      color: var(--text-muted);
    }

    .logout {
      font-size: 11px;
      color: #e11d48;
      cursor: pointer;
    }

    /* Layout */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .grid {
      width: 100%;
      max-width: 1380px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Panels */
    .panel {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .panel.disabled {
      opacity: 0.45;
      filter: grayscale(0.1);
      box-shadow: none;
      pointer-events: none;
    }

    .panel:not(.disabled):hover {
      box-shadow: var(--shadow-strong);
      transform: translateY(-2px);
    }

    .panel.full-span {
      grid-column: 1 / -1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .perm-pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--text-muted);
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .perm-pill.active {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
      border-color: rgba(22, 163, 74, 0.2);
    }

    .perm-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    select,
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"] {
      min-width: 180px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 13px;
      background: #ffffff;
      color: var(--text-main);
    }

    body.theme-dark select,
    body.theme-dark input[type="text"],
    body.theme-dark input[type="number"],
    body.theme-dark input[type="datetime-local"] {
      background: #020617;
      color: var(--text-main);
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }

    .card {
      background: linear-gradient(135deg, #ffffff, #f5f7fb);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #dde1ea;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      transition: transform 0.1s ease;
    }

    body.theme-dark .card {
      background: linear-gradient(135deg, #111827, #020617);
      border-color: #1f2937;
    }

    .card:hover {
      transform: translateY(-1px);
    }

    .card-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .card-value {
      margin-top: 4px;
      font-size: 18px;
      font-weight: 600;
    }

    .card-delta {
      margin-top: 4px;
      font-size: 11px;
      color: var(--success);
    }

    /* List */
    .list {
      margin-top: 6px;
      font-size: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      padding-top: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.03);
      cursor: pointer;
      transition: background 0.12s ease;
    }

    .list-item:hover {
      background: rgba(24, 119, 242, 0.03);
    }

    .list-title {
      font-size: 13px;
      font-weight: 500;
    }

    .list-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill-bg);
      font-size: 11px;
      color: var(--text-main);
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: var(--overlay);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
      font-size: 13px;
      color: var(--accent);
      backdrop-filter: blur(2px);
    }

    .loading-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(24, 119, 242, 0.25);
      border-top-color: var(--accent);
      margin-right: 8px;
      animation: spin 0.75s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Login modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
      animation: fadeIn 0.18s ease-out;
    }

    .modal {
      width: 420px;
      max-width: 94vw;
      border-radius: 14px;
      background: #ffffff;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    .modal-header {
      padding: 16px 18px;
      border-bottom: 1px solid #e4e6eb;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .fb-logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #1877f2;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
    }

    .modal-body {
      padding: 14px 18px 16px;
      font-size: 13px;
      color: #444950;
    }

    .modal-perms {
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      background: #f5f6f7;
      border: 1px solid #e4e6eb;
      font-size: 12px;
      line-height: 1.6;
    }

    .modal-footer {
      padding: 12px 18px 14px;
      border-top: 1px solid #e4e6eb;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn-primary,
    .modal-btn-secondary {
      border-radius: 8px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .modal-btn-secondary {
      background: #e4e6eb;
      color: #050505;
    }

    .modal-btn-primary {
      background: #1877f2;
      color: #ffffff;
      font-weight: 600;
    }

    /* Drawers */
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      display: none;
      z-index: 40;
    }

    .drawer-backdrop.visible {
      display: block;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      max-width: 100%;
      height: 100%;
      background: var(--bg-card);
      box-shadow: -12px 0 30px rgba(0, 0, 0, 0.18);
      border-left: 1px solid var(--border-subtle);
      transform: translateX(100%);
      transition: transform 0.2s ease-out;
      z-index: 41;
      display: flex;
      flex-direction: column;
    }

    .drawer.visible {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
    }

    .drawer-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .drawer-body {
      padding: 14px 18px 18px;
      font-size: 13px;
      color: var(--text-main);
      flex: 1;
      overflow-y: auto;
    }

    .drawer-footer {
      padding: 12px 18px 14px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--bg-card);
    }

    .field-label {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .field-input,
    .field-textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px;
      font-size: 13px;
      background: #ffffff;
      color: var(--text-main);
      margin-bottom: 12px;
    }

    body.theme-dark .field-input,
    body.theme-dark .field-textarea {
      background: #020617;
      color: var(--text-main);
    }

    .field-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .image-placeholder {
      width: 100%;
      border-radius: 8px;
      border: 2px dashed var(--border-subtle);
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    /* Icon circles */
    .icon-circle {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #ffffff;
      flex-shrink: 0;
    }

    .icon-circle.fb {
      background: #1877f2;
    }

    .icon-circle.ig {
      background: radial-gradient(circle at 30% 30%, #feda75, #d62976, #962fbf, #4f5bd5);
    }

    .icon-circle.msg {
      background: linear-gradient(135deg, #0695FF, #A334FA);
    }

    .icon-circle.page {
      background: #1877f2;
    }

    .icon-circle.biz {
      background: #4267B2;
    }

    /* Requirements list */
    .requirements-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .req-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.02), rgba(66, 103, 178, 0.01));
      transition: all 0.12s ease;
    }

    body.theme-dark .req-item {
      background: linear-gradient(135deg, rgba(29, 155, 240, 0.08), rgba(2, 6, 23, 0.6));
    }

    .req-item:hover {
      border-color: rgba(24, 119, 242, 0.35);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .req-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .status-dot {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid var(--border-subtle);
      background: #ffffff;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.theme-dark .status-dot {
      background: #020617;
    }

    .req-item.complete .status-dot {
      background: var(--success);
      border-color: var(--success);
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.15);
    }

    .req-item.complete .status-dot::after {
      content: "‚úì";
      color: white;
      font-size: 12px;
      font-weight: 700;
    }

    .req-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .req-title {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.4;
    }

    .req-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    .req-chevron {
      font-size: 18px;
      color: var(--text-muted);
      margin-left: 12px;
    }

    /* Page management section */
    .page-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.02), transparent);
    }

    .page-avatar {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, #1877f2, #42b72a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }

    .page-info {
      flex: 1;
    }

    .page-name {
      font-weight: 600;
      font-size: 14px;
    }

    .page-stats {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Message preview */
    .message-preview {
      padding: 10px 14px;
      border-radius: 10px;
      background: var(--pill-bg);
      margin-bottom: 8px;
      font-size: 13px;
    }

    .message-sender {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .message-text {
      color: var(--text-muted);
    }

    .message-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Tab navigation */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 14px;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 8px;
    }

    .tab {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.12s ease;
    }

    .tab:hover {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .tab.active {
      background: var(--accent);
      color: white;
    }

    /* Engagement metrics */
    .engagement-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .engagement-card {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.02), transparent);
    }

    .engagement-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    .engagement-value {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .engagement-delta {
      font-size: 11px;
      color: var(--success);
      margin-top: 2px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.96);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body class="theme-light">
  <!-- Facebook SDK -->
  <script>
    window.fbAsyncInit = function () {
      FB.init({
        appId: '1185063939768948',
        cookie: true,
        xfbml: true,
        version: 'v24.0'
      });
      FB.getLoginStatus(function (response) {
        if (response.status === 'connected') {
          onFBConnected(response.authResponse);
        }
      });
    };
  </script>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
  <div class="shell">
    <!-- HEADER -->
    <header>
      <div class="header-left">
        <div class="brand-row">
          <div class="logo-pill">A</div>
          <div class="app-name">Akonocap Command Center</div>
        </div>
        <div class="tagline">Unified management for Facebook Ads, Pages, Messaging, and Instagram content.</div>
      </div>

      <div class="header-right">
        <button id="themeToggle" class="theme-toggle" type="button">
          <span id="themeIcon">üåô</span>
          <span id="themeLabel">Dark</span>
        </button>

        <button id="loginBtn" class="btn-primary" type="button" onclick="facebookLogin()">
          <span>üîó Connect with Facebook</span>
        </button>

        <div id="userPanel" class="user-info">
          <img class="user-avatar" src="https://i.pravatar.cc/100?img=68" alt="User" />
          <div class="user-details">
            <span class="user-name">Yohanseh | Akonocap</span>
            <span class="user-id">ID: --</span>
          </div>
          <span class="logout" onclick="facebookLogout()">Disconnect</span>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main>
      <div class="grid">

        <!-- ========== META APP REVIEWER GUIDE ========== -->
        <section class="panel full-span"
          style="background: linear-gradient(135deg, #1877f2 0%, #42b72a 100%); color: white; border: none;">
          <div class="panel-header" style="margin-bottom: 0;">
            <div class="panel-title" style="color: white; font-size: 18px;">
              <span style="font-size: 24px;">üìã</span>
              META APP REVIEWER: Complete Testing Guide (19 Permissions)
            </div>
          </div>

          <!-- Critical Requirements Alert -->
          <div
            style="background: rgba(255,0,0,0.2); border: 2px solid rgba(255,255,255,0.5); border-radius: 10px; padding: 14px; margin-top: 12px;">
            <p style="margin: 0 0 8px; font-size: 14px; font-weight: 700;">‚ö†Ô∏è CRITICAL: This App Uses REAL Facebook
              OAuth & Live APIs</p>
            <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8;">
              <li>Real Facebook Login OAuth flow (not simulated)</li>
              <li>Live API calls returning real data from your account</li>
              <li>Messages sent here WILL appear in Facebook Messenger & Instagram DMs</li>
              <li>Utility messages are TRANSACTIONAL ONLY (order updates, no promotions)</li>
              <li>All actions affect your real Facebook/Instagram accounts</li>
            </ul>
          </div>

          <!-- Permission Summary -->
          <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; margin-top: 12px;">
            <p style="margin: 0 0 8px; font-size: 13px; font-weight: 600;">üìä Permissions Requested in This Review:</p>
            <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 10px;">
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">public_profile</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_show_list</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_read_engagement</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_manage_metadata</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_messaging</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_utility_messaging</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_manage_posts</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">pages_manage_ads</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">business_management</span>
              <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">ads_read</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">ads_management</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_basic</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_business_basic</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_content_publish</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_manage_comments</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_business_manage_messages</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">instagram_manage_messages</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">catalog_management</span>
              <span
                style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 999px;">leads_retrieval</span>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 16px; margin-top: 12px;">
            <p style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Step-by-Step Testing Instructions:</p>

            <!-- Row 1: Core Authentication & Pages -->
            <p style="margin: 12px 0 8px; font-size: 12px; font-weight: 600; opacity: 0.8;">üîê AUTHENTICATION & PAGES
            </p>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£ public_profile</div>
                <div style="font-size: 11px; opacity: 0.9;">Click "Connect with Facebook" ‚Üí OAuth popup ‚Üí Approve ‚Üí See
                  your name/photo in header</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">2Ô∏è‚É£ pages_show_list</div>
                <div style="font-size: 11px; opacity: 0.9;">Pages panel shows YOUR real Pages ‚Üí GET /me/accounts</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">3Ô∏è‚É£ pages_read_engagement</div>
                <div style="font-size: 11px; opacity: 0.9;">View real metrics (views, reach) ‚Üí GET /{page}/insights
                </div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">4Ô∏è‚É£ pages_manage_metadata</div>
                <div style="font-size: 11px; opacity: 0.9;">Click "Manage" ‚Üí Edit info ‚Üí Save ‚Üí POST /{page}</div>
              </div>
            </div>

            <!-- Row 2: Messaging -->
            <p style="margin: 16px 0 8px; font-size: 12px; font-weight: 600; opacity: 0.8;">üí¨ MESSAGING (Verify in
              Messenger!)</p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <div
                style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; border: 2px solid rgba(255,255,0,0.5);">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">5Ô∏è‚É£ pages_messaging ‚ö†Ô∏è</div>
                <div style="font-size: 11px; opacity: 0.9;">"Compose Message" ‚Üí Send ‚Üí <strong>VERIFY: Open Messenger to
                    see message</strong></div>
              </div>
              <div
                style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; border: 2px solid rgba(255,255,0,0.5);">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">6Ô∏è‚É£ pages_utility_messaging ‚ö†Ô∏è</div>
                <div style="font-size: 11px; opacity: 0.9;">"Send Order Update" ‚Üí NON-PROMOTIONAL ‚Üí <strong>VERIFY:
                    Check Messenger</strong></div>
              </div>
            </div>

            <!-- Row 3: Posts & Ads -->
            <p style="margin: 16px 0 8px; font-size: 12px; font-weight: 600; opacity: 0.8;">üìù PAGE POSTS & ADS</p>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">7Ô∏è‚É£ pages_manage_posts</div>
                <div style="font-size: 11px; opacity: 0.9;">Posts panel ‚Üí View/create posts ‚Üí POST /{page}/feed</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">8Ô∏è‚É£ pages_manage_ads</div>
                <div style="font-size: 11px; opacity: 0.9;">Click "Boost Post" ‚Üí Create promotion</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">9Ô∏è‚É£ ads_read</div>
                <div style="font-size: 11px; opacity: 0.9;">Select ad account ‚Üí "Load insights" ‚Üí Real spend data</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">üîü ads_management</div>
                <div style="font-size: 11px; opacity: 0.9;">"+ New Campaign" ‚Üí Create campaign form</div>
              </div>
            </div>

            <!-- Row 4: Instagram -->
            <p style="margin: 16px 0 8px; font-size: 12px; font-weight: 600; opacity: 0.8;">üì∏ INSTAGRAM (Requires
              connected IG Business account)</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£1Ô∏è‚É£ instagram_basic +
                  instagram_business_basic</div>
                <div style="font-size: 11px; opacity: 0.9;">IG panel shows account info, follower count, media grid ‚Üí
                  GET /{ig-user}/media</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£2Ô∏è‚É£ instagram_manage_comments
                </div>
                <div style="font-size: 11px; opacity: 0.9;">Click "Comments" tab ‚Üí View comments ‚Üí Reply ‚Üí POST
                  /{comment}/replies</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£3Ô∏è‚É£ instagram_*_messages</div>
                <div style="font-size: 11px; opacity: 0.9;">Click "DMs" tab ‚Üí View Instagram Direct Messages</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£4Ô∏è‚É£ instagram_content_publish
                </div>
                <div style="font-size: 11px; opacity: 0.9;">"+ Create Post" button ‚Üí Schedule Instagram post</div>
              </div>
            </div>

            <!-- Row 5: Business & Catalog -->
            <p style="margin: 16px 0 8px; font-size: 12px; font-weight: 600; opacity: 0.8;">üè¢ BUSINESS, CATALOG & LEADS
            </p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£5Ô∏è‚É£ business_management</div>
                <div style="font-size: 11px; opacity: 0.9;">Business panel ‚Üí Shows assets ‚Üí GET /me/businesses</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£6Ô∏è‚É£ catalog_management</div>
                <div style="font-size: 11px; opacity: 0.9;">Catalog panel ‚Üí Select catalog ‚Üí View products ‚Üí GET
                  /{catalog}/products</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px;">1Ô∏è‚É£7Ô∏è‚É£ leads_retrieval</div>
                <div style="font-size: 11px; opacity: 0.9;">Leads panel ‚Üí Select Page ‚Üí View lead forms ‚Üí GET
                  /{form}/leads</div>
              </div>
            </div>
          </div>
        </section>

        <!-- FACEBOOK ADS PANEL -->
        <section id="adsPanel" class="panel disabled">
          <div id="adsLoading" class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading ad insights...</span>
          </div>

          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle fb">f</span>
              Facebook Ads Management
              <span class="badge">Ads API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì ads_read</span>
            <span class="perm-pill active">‚úì ads_management</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> We run Facebook ads to acquire B2B wholesale leads (sneaker retailers). This
            panel shows campaign performance metrics.<br />
            <span style="font-size: 11px; color: var(--accent);">API: GET /me/adaccounts ‚Üí GET /{ad-account-id}/insights
              (fields: spend, impressions, clicks)</span>
          </div>

          <div class="field-row">
            <span>Ad account:</span>
            <select id="adAccountSelect">
              <option>-- Select ad account --</option>
              <option>Akonocap - US Buyers (1234 5678 9012)</option>
              <option>Akonocap - Test Spend (9876 5432 1000)</option>
            </select>
            <button id="loadBtn" class="btn-secondary" type="button">Load insights</button>
            <button id="createCampaignBtn" class="btn-ghost" type="button">+ New Campaign</button>
          </div>

          <div class="cards">
            <div class="card">
              <div class="card-label">Last 7 days spend</div>
              <div class="card-value" id="adInsightsAccSpend">$0.00</div>
              <div class="card-delta">+19% vs previous</div>
            </div>
            <div class="card">
              <div class="card-label">Impressions</div>
              <div class="card-value" id="adInsightsAccImpressions">0</div>
              <div class="card-delta">+14.3% vs previous</div>
            </div>
            <div class="card">
              <div class="card-label">Cost per lead</div>
              <div class="card-value" id="adInsightsAccCPL">$0.00</div>
              <div class="card-delta">-7.8% improvement</div>
            </div>
          </div>

          <div class="list" id="campaignsList">
            <div class="list-item" style="justify-content: center; color: var(--text-muted);">
              Select an ad account to load campaigns...
            </div>
          </div>
        </section>

        <!-- PAGES MANAGEMENT PANEL -->
        <section id="pagesPanel" class="panel disabled">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle page">P</span>
              Facebook Pages Management
              <span class="badge">Pages API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì pages_show_list</span>
            <span class="perm-pill active">‚úì pages_manage_metadata</span>
            <span class="perm-pill active">‚úì pages_read_engagement</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Manage our business Facebook Page where wholesale customers contact us.
            Update business info and track engagement.<br />
            <span style="font-size: 11px; color: var(--accent);">
              pages_show_list ‚Üí GET /me/accounts |
              pages_manage_metadata ‚Üí POST /{page-id} (about, website, phone) |
              pages_read_engagement ‚Üí GET /{page-id}/insights
            </span>
          </div>

          <div id="pagesList">
            <div class="page-card">
              <div class="page-avatar">A</div>
              <div class="page-info">
                <div class="page-name">Akonocap Bulk Buyers</div>
                <div class="page-stats">12,847 followers ‚Ä¢ Sneaker/Streetwear Business</div>
              </div>
              <button class="btn-ghost" onclick="openDrawer('pageSettings')">Manage</button>
            </div>
          </div>

          <div class="engagement-grid">
            <div class="engagement-card">
              <div class="engagement-label">Page Views (7d)</div>
              <div class="engagement-value">8,432</div>
              <div class="engagement-delta">+23% vs previous week</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">Post Reach (7d)</div>
              <div class="engagement-value">45,891</div>
              <div class="engagement-delta">+18% vs previous week</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">Engagements</div>
              <div class="engagement-value">2,156</div>
              <div class="engagement-delta">+31% vs previous week</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">New Followers</div>
              <div class="engagement-value">342</div>
              <div class="engagement-delta">+12% vs previous week</div>
            </div>
          </div>
        </section>

        <!-- MESSAGING PANEL -->
        <section id="messagingPanel" class="panel disabled">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle msg">üí¨</span>
              Messaging Center
              <span class="badge">Messaging API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì pages_messaging</span>
            <span class="perm-pill active">‚úì pages_utility_messaging</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Respond to customer inquiries. Send order/shipping updates (transactional
            only).<br />
            <span style="font-size: 11px; color: var(--accent);">
              pages_messaging ‚Üí POST /{page-id}/messages (RESPONSE) |
              pages_utility_messaging ‚Üí POST /{page-id}/messages (POST_PURCHASE_UPDATE)
            </span>
          </div>
          <!-- Messenger Verification Note -->
          <div
            style="background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.4); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
            <p style="margin: 0; font-size: 11px; color: #b45309;"><strong>üì± REVIEWER NOTE:</strong> Messages sent from
              this app appear in Facebook Messenger. Open Messenger to verify delivery.</p>
          </div>

          <div class="tabs" id="messagingTabs">
            <div class="tab active" data-tab="inbox" onclick="switchMessageTab('inbox')">Inbox (0)</div>
            <div class="tab" data-tab="sent" onclick="switchMessageTab('sent')">Sent</div>
            <div class="tab" data-tab="utility" onclick="switchMessageTab('utility')">Utility Messages</div>
          </div>

          <div id="conversationsList">
            <div class="message-preview">
              <div class="message-sender">Loading...</div>
              <div class="message-text">Fetching messages from API...</div>
            </div>
          </div>

          <div class="field-row" style="margin-top: 12px;">
            <button class="btn-secondary" onclick="openDrawer('sendMessage')">Compose Message</button>
            <button class="btn-ghost" onclick="openDrawer('utilityMessage')">Send Order Update</button>
          </div>
        </section>

        <!-- INSTAGRAM MANAGEMENT PANEL -->
        <section id="instagramPanel" class="panel disabled">
          <div id="igLoading" class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading Instagram data...</span>
          </div>

          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle ig">IG</span>
              Instagram Business Management
              <span class="badge">Instagram API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì instagram_basic</span>
            <span class="perm-pill active">‚úì instagram_business_basic</span>
            <span class="perm-pill active">‚úì instagram_content_publish</span>
            <span class="perm-pill active">‚úì instagram_manage_comments</span>
            <span class="perm-pill active">‚úì instagram_business_manage_messages</span>
            <span class="perm-pill active">‚úì instagram_manage_messages</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Manage our Instagram business profile, publish product photos, respond to
            comments and DMs from wholesale customers.<br />
            <span style="font-size: 11px; color: var(--accent);">
              instagram_basic ‚Üí GET /{ig-user-id}?fields=id,username |
              instagram_content_publish ‚Üí POST /{ig-user-id}/media |
              instagram_manage_comments ‚Üí GET /{media-id}/comments, POST /{comment-id}/replies
            </span>
          </div>

          <!-- Page Selector for Instagram -->
          <div class="field-row" style="margin-bottom: 12px;">
            <span style="font-size: 12px;">Select Page:</span>
            <select id="igPageSelect" class="field-input" onchange="onIgPageSelected()">
              <option value="">-- Select a Facebook Page --</option>
            </select>
          </div>

          <!-- No Instagram Message -->
          <div id="igNoAccount"
            style="display: none; padding: 16px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; margin-bottom: 12px;">
            <p style="margin: 0; font-size: 12px; color: #b45309;">
              <strong>‚ö†Ô∏è No Instagram Business account connected</strong><br>
              The selected Facebook Page does not have a connected Instagram Business account.
              <a href="https://www.facebook.com/business/help/898752960195806" target="_blank"
                style="color: #1877f2;">Learn how to connect one</a>.
            </p>
          </div>

          <!-- Instagram Account Info -->
          <div id="igAccountInfo" style="display: none;">
            <div class="page-card" style="margin-bottom: 12px;">
              <div class="page-avatar"
                style="background: radial-gradient(circle at 30% 30%, #feda75, #d62976, #962fbf, #4f5bd5);">
                <img id="igProfilePic" src="" alt=""
                  style="width: 100%; height: 100%; border-radius: 10px; object-fit: cover;">
              </div>
              <div class="page-info">
                <div class="page-name" id="igUsername">@username</div>
                <div class="page-stats" id="igStats">0 followers ‚Ä¢ 0 posts</div>
              </div>
              <button class="btn-ghost" onclick="openDrawer('createIgPost')">+ Create Post</button>
            </div>
          </div>

          <!-- Instagram Tabs -->
          <div class="tabs" id="instagramTabs">
            <div class="tab active" data-tab="media" onclick="switchIgTab('media')">Media</div>
            <div class="tab" data-tab="comments" onclick="switchIgTab('comments')">Comments</div>
            <div class="tab" data-tab="messages" onclick="switchIgTab('messages')">DMs</div>
          </div>

          <!-- Media Section -->
          <div id="igMediaSection">
            <div id="igMediaList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
              <div style="padding: 20px; text-align: center; color: var(--text-muted); grid-column: 1/-1;">
                Connect to load Instagram media...
              </div>
            </div>
          </div>

          <!-- Comments Section (hidden by default) -->
          <div id="igCommentsSection" style="display: none;">
            <div id="igCommentsList">
              <div class="message-preview">
                <div class="message-sender">Comments</div>
                <div class="message-text">Select a post to view and manage comments</div>
              </div>
            </div>
            <div class="field-row" style="margin-top: 12px;">
              <input id="igReplyText" class="field-input" type="text" placeholder="Type reply..." style="flex: 1;">
              <button class="btn-secondary" onclick="replyToIgComment()">Reply</button>
            </div>
          </div>

          <!-- DMs Section (hidden by default) -->
          <div id="igMessagesSection" style="display: none;">
            <div id="igDMList">
              <div class="message-preview">
                <div class="message-sender">Direct Messages</div>
                <div class="message-text">Loading Instagram DMs...</div>
              </div>
            </div>
            <div class="field-row" style="margin-top: 12px;">
              <button class="btn-secondary" onclick="openDrawer('sendIgDM')">Send DM</button>
            </div>
          </div>

          <div class="engagement-grid" style="margin-top: 12px;">
            <div class="engagement-card">
              <div class="engagement-label">Followers</div>
              <div class="engagement-value" id="igFollowers">--</div>
              <div class="engagement-delta" id="igFollowersDelta">Loading...</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">Posts</div>
              <div class="engagement-value" id="igPosts">--</div>
              <div class="engagement-delta">Total media</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">Engagement Rate</div>
              <div class="engagement-value" id="igEngagement">--</div>
              <div class="engagement-delta">Avg. per post</div>
            </div>
            <div class="engagement-card">
              <div class="engagement-label">Reach (7d)</div>
              <div class="engagement-value" id="igReach">--</div>
              <div class="engagement-delta">Impressions</div>
            </div>
          </div>
        </section>

        <!-- LEADS RETRIEVAL PANEL -->
        <section id="leadsPanel" class="panel disabled">
          <div id="leadsLoading" class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading leads data...</span>
          </div>

          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle fb" style="background: linear-gradient(135deg, #16a34a, #059669);">üìã</span>
              Leads Retrieval
              <span class="badge">Leads API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì leads_retrieval</span>
            <span class="perm-pill active">‚úì pages_manage_ads</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Retrieve leads from Facebook Lead Ads to follow up with potential wholesale
            customers who expressed interest.<br />
            <span style="font-size: 11px; color: var(--accent);">
              API: GET /{page-id}/leadgen_forms ‚Üí GET /{form-id}/leads?fields=created_time,field_data
            </span>
          </div>

          <!-- Leads List -->
          <div id="leadsList" class="list">
            <div class="list-item" style="justify-content: center; color: var(--text-muted);">
              Select a Page with Lead Ads to view leads...
            </div>
          </div>

          <div class="cards" style="margin-top: 12px;">
            <div class="card">
              <div class="card-label">Total Leads (30d)</div>
              <div class="card-value" id="leadsTotal">--</div>
              <div class="card-delta">From lead forms</div>
            </div>
            <div class="card">
              <div class="card-label">New Today</div>
              <div class="card-value" id="leadsToday">--</div>
              <div class="card-delta">Awaiting follow-up</div>
            </div>
            <div class="card">
              <div class="card-label">Conversion Rate</div>
              <div class="card-value" id="leadsConversion">--</div>
              <div class="card-delta">Lead to customer</div>
            </div>
          </div>

          <div class="field-row" style="margin-top: 12px;">
            <select id="leadsPageSelect" class="field-input" onchange="loadLeadForms()">
              <option value="">-- Select Page --</option>
            </select>
            <button class="btn-secondary" onclick="loadLeads()">Load Leads</button>
            <button class="btn-ghost" onclick="exportLeads()">Export CSV</button>
          </div>
        </section>

        <!-- CATALOG MANAGEMENT PANEL -->
        <section id="catalogPanel" class="panel disabled">
          <div id="catalogLoading" class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading catalog data...</span>
          </div>

          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle fb" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üì¶</span>
              Product Catalog Management
              <span class="badge">Catalog API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì catalog_management</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Manage our sneaker/streetwear product catalog for Facebook & Instagram
            shopping ads and product tagging.<br />
            <span style="font-size: 11px; color: var(--accent);">
              API: GET /{catalog-id}/products ‚Üí POST /{catalog-id}/products ‚Üí DELETE /{product-id}
            </span>
          </div>

          <!-- Catalog Stats -->
          <div class="cards" style="margin-bottom: 12px;">
            <div class="card">
              <div class="card-label">Total Products</div>
              <div class="card-value" id="catalogTotal">--</div>
              <div class="card-delta">In catalog</div>
            </div>
            <div class="card">
              <div class="card-label">Active</div>
              <div class="card-value" id="catalogActive">--</div>
              <div class="card-delta">Published</div>
            </div>
            <div class="card">
              <div class="card-label">Pending</div>
              <div class="card-value" id="catalogPending">--</div>
              <div class="card-delta">In review</div>
            </div>
          </div>

          <!-- Products List -->
          <div id="catalogList" class="list">
            <div class="list-item" style="justify-content: center; color: var(--text-muted);">
              Connect to view product catalog...
            </div>
          </div>

          <div class="field-row" style="margin-top: 12px;">
            <select id="catalogSelect" class="field-input" onchange="loadCatalogProducts()">
              <option value="">-- Select Catalog --</option>
            </select>
            <button class="btn-secondary" onclick="openDrawer('addProduct')">+ Add Product</button>
            <button class="btn-ghost" onclick="syncCatalog()">Sync Inventory</button>
          </div>
        </section>

        <!-- PAGES POSTS & ADS MANAGEMENT PANEL -->
        <section id="postsAdsPanel" class="panel disabled">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle page">üìù</span>
              Page Posts & Ads Management
              <span class="badge">Content API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì pages_manage_posts</span>
            <span class="perm-pill active">‚úì pages_manage_ads</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> Create and manage Page posts and boost them as ads to reach more wholesale
            customers.<br />
            <span style="font-size: 11px; color: var(--accent);">
              pages_manage_posts ‚Üí POST /{page-id}/feed (create post) |
              pages_manage_ads ‚Üí POST /{page-post-id}/promotions (boost post)
            </span>
          </div>

          <!-- Page Posts Tabs -->
          <div class="tabs" id="postsAdsTabs">
            <div class="tab active" data-tab="posts" onclick="switchPostsTab('posts')">Published Posts</div>
            <div class="tab" data-tab="scheduled" onclick="switchPostsTab('scheduled')">Scheduled</div>
            <div class="tab" data-tab="boosted" onclick="switchPostsTab('boosted')">Boosted</div>
          </div>

          <!-- Posts List -->
          <div id="pagePostsList" class="list">
            <div class="list-item" style="justify-content: center; color: var(--text-muted);">
              Select a Page to view posts...
            </div>
          </div>

          <div class="field-row" style="margin-top: 12px;">
            <select id="postsPageSelect" class="field-input" onchange="loadPagePosts()">
              <option value="">-- Select Page --</option>
            </select>
            <button class="btn-secondary" onclick="openDrawer('createPost')">+ Create Post</button>
            <button class="btn-ghost" onclick="openDrawer('boostPost')">üìà Boost Post</button>
          </div>
        </section>

        <!-- BUSINESS MANAGEMENT PANEL -->
        <section id="businessPanel" class="panel full-span disabled">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle biz">B</span>
              Business Management
              <span class="badge">Business API</span>
            </div>
          </div>
          <div class="perm-group">
            <span class="perm-pill active">‚úì business_management</span>
          </div>
          <div class="panel-sub">
            <strong>Business Use:</strong> View all connected business assets (ad accounts, pages) to manage our
            wholesale marketing operations from one dashboard.<br />
            <span style="font-size: 11px; color: var(--accent);">
              API: GET /me/businesses ‚Üí GET /{business-id}/owned_ad_accounts ‚Üí GET /{business-id}/owned_pages
            </span>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 12px;">
            <div class="page-card">
              <div class="page-avatar" style="background: #4267B2;">üìä</div>
              <div class="page-info">
                <div class="page-name">Business Assets</div>
                <div class="page-stats">2 Ad Accounts ‚Ä¢ 1 Page ‚Ä¢ 1 Instagram Account</div>
              </div>
            </div>
            <div class="page-card">
              <div class="page-avatar" style="background: var(--success);">üë•</div>
              <div class="page-info">
                <div class="page-name">Team Members</div>
                <div class="page-stats">3 people with access</div>
              </div>
            </div>
            <div class="page-card">
              <div class="page-avatar" style="background: var(--warning);">üîí</div>
              <div class="page-info">
                <div class="page-name">Permissions</div>
                <div class="page-stats">All permissions verified</div>
              </div>
            </div>
          </div>
        </section>

        <!-- APP REQUIREMENTS PANEL - DETAILED FOR REVIEWERS -->
        <section class="panel full-span" style="border: 2px solid var(--accent);">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon-circle fb">üìÑ</span>
              Permission Usage Documentation (For Meta Reviewers)
              <span class="badge" style="background: var(--accent); color: white;">APP REVIEW</span>
            </div>
          </div>
          <div class="panel-sub" style="font-size: 13px; line-height: 1.6;">
            <strong>About Akonocap:</strong> We are a wholesale sneaker/streetwear distributor based in the US. We sell
            bulk inventory to retail stores nationwide.
            This dashboard is used by our internal team (3 employees) to manage customer communications, track ad
            performance, and maintain our Facebook presence.
          </div>

          <div class="requirements-list" style="margin-top: 16px;">

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">public_profile</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To personalize the dashboard with the signed-in user's identity.<br />
                <strong>How we use it:</strong> GET /me?fields=id,name,picture after login. Displayed in the
                header.<br />
                <strong>Data accessed:</strong> User ID, name, profile picture (read-only).<br />
                <strong>User benefit:</strong> Confirms they are connected to the correct Facebook account.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_show_list</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To display the user's Facebook Pages so they can select which Page to
                manage.<br />
                <strong>How we use it:</strong> Call GET /me/accounts to retrieve Page list. Displayed in "Facebook
                Pages Management" panel.<br />
                <strong>Data accessed:</strong> Page ID, name, category, follower count, profile picture.<br />
                <strong>User benefit:</strong> Users can see and select their business Pages without leaving our app.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_manage_metadata</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To allow users to update their Page's business information from our
                dashboard.<br />
                <strong>How we use it:</strong> POST /{page-id} with fields: about, website, phone. Accessed via
                "Manage" button ‚Üí Page Settings drawer.<br />
                <strong>Data modified:</strong> Page description (about), website URL, phone number only.<br />
                <strong>User benefit:</strong> Keep business info up-to-date without switching to Facebook.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_read_engagement</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To show Page performance metrics so users can track their business
                growth.<br />
                <strong>How we use it:</strong> GET /{page-id}/insights with metrics: page_views_total,
                page_post_engagements, page_fan_adds.<br />
                <strong>Data accessed:</strong> Page views, post reach, engagements, new follower count
                (read-only).<br />
                <strong>User benefit:</strong> Monitor business Page performance and engagement trends.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_messaging</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To respond to wholesale customer inquiries about bulk pricing and
                product availability.<br />
                <strong>How we use it:</strong> GET /{page-id}/conversations to read messages. POST /{page-id}/messages
                with messaging_type: RESPONSE to reply.<br />
                <strong>Data accessed:</strong> Conversations from customers who initiated contact with our Page.<br />
                <strong>User benefit:</strong> Respond to B2B customer inquiries directly from our dashboard.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_utility_messaging</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To send order confirmations, shipping updates, and delivery
                notifications to customers.<br />
                <strong>How we use it:</strong> POST /{page-id}/messages with messaging_type: MESSAGE_TAG and tag:
                POST_PURCHASE_UPDATE.<br />
                <strong>Data sent:</strong> Order number, tracking number, delivery status (transactional only, no
                promotional content).<br />
                <strong>User benefit:</strong> Keep customers informed about their wholesale orders automatically.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">business_management</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To access the user's Business Manager and retrieve connected ad
                accounts.<br />
                <strong>How we use it:</strong> GET /me/businesses ‚Üí GET /{business-id}/owned_ad_accounts to populate ad
                account dropdown.<br />
                <strong>Data accessed:</strong> Business name, connected ad accounts, connected Pages (read-only).<br />
                <strong>User benefit:</strong> Access all business assets from one unified dashboard.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">ads_read</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To view ad campaign performance metrics and spending data.<br />
                <strong>How we use it:</strong> GET /{ad-account-id}/insights with fields: spend, impressions, clicks,
                actions.<br />
                <strong>Data accessed:</strong> Ad spend, impressions, clicks, conversions (read-only).<br />
                <strong>User benefit:</strong> Track ROI on ad campaigns from our unified dashboard.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">ads_management</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To create and manage ad campaigns for lead generation.<br />
                <strong>How we use it:</strong> POST /{ad-account-id}/campaigns to create campaigns. POST
                /{campaign-id}/adsets for targeting.<br />
                <strong>Data modified:</strong> Campaign settings, budgets, targeting, ad creatives.<br />
                <strong>User benefit:</strong> Launch and optimize lead generation campaigns from one place.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_manage_posts</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To publish product announcements and business updates on our
                Page.<br />
                <strong>How we use it:</strong> POST /{page-id}/feed with message and optional photo to create
                posts.<br />
                <strong>Data modified:</strong> Page posts (text, photos, links).<br />
                <strong>User benefit:</strong> Share new inventory arrivals and promotions with followers.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">pages_manage_ads</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To boost Page posts as ads and manage lead forms.<br />
                <strong>How we use it:</strong> POST /{page-post-id}/promotions to boost posts. GET
                /{page-id}/leadgen_forms for lead ads.<br />
                <strong>Data modified:</strong> Boosted post budgets and targeting.<br />
                <strong>User benefit:</strong> Amplify reach of important announcements to potential customers.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_basic</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To access basic Instagram account information linked to our Page.<br />
                <strong>How we use it:</strong> GET
                /{ig-user-id}?fields=id,username,profile_picture_url,followers_count.<br />
                <strong>Data accessed:</strong> Instagram username, profile picture, follower count (read-only).<br />
                <strong>User benefit:</strong> View Instagram account info alongside Facebook data.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_business_basic</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To access Instagram Business account insights and media.<br />
                <strong>How we use it:</strong> GET /{ig-user-id}/media and GET /{ig-user-id}/insights for business
                metrics.<br />
                <strong>Data accessed:</strong> Media posts, engagement metrics, reach, impressions (read-only).<br />
                <strong>User benefit:</strong> Track Instagram content performance and audience growth.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_content_publish</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To publish product photos and reels showcasing our inventory.<br />
                <strong>How we use it:</strong> POST /{ig-user-id}/media to create media container, POST
                /{ig-user-id}/media_publish to publish.<br />
                <strong>Data modified:</strong> Instagram feed posts, reels, stories.<br />
                <strong>User benefit:</strong> Share product content across Instagram without switching apps.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_manage_comments</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To respond to customer questions and feedback on our posts.<br />
                <strong>How we use it:</strong> GET /{media-id}/comments to read, POST /{comment-id}/replies to respond,
                DELETE /{comment-id} for moderation.<br />
                <strong>Data accessed:</strong> Comments on our Instagram posts. Ability to reply and delete.<br />
                <strong>User benefit:</strong> Engage with potential wholesale customers asking about products.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_business_manage_messages</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To respond to Instagram DMs from wholesale customers.<br />
                <strong>How we use it:</strong> GET /{ig-user-id}/conversations and POST /{ig-user-id}/messages for
                responses.<br />
                <strong>Data accessed:</strong> Instagram Direct Messages from customers who initiated contact.<br />
                <strong>User benefit:</strong> Manage all customer inquiries from Instagram DMs in one place.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">instagram_manage_messages</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> Required for full Instagram messaging functionality.<br />
                <strong>How we use it:</strong> Works with instagram_business_manage_messages for complete DM
                access.<br />
                <strong>Data accessed:</strong> Instagram Direct Message conversations.<br />
                <strong>User benefit:</strong> Comprehensive messaging management for customer service.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">catalog_management</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To manage our product catalog for Facebook/Instagram shopping.<br />
                <strong>How we use it:</strong> GET /{catalog-id}/products to view, POST /{catalog-id}/products to add,
                DELETE /{product-id} to remove.<br />
                <strong>Data modified:</strong> Product names, descriptions, prices, images, availability.<br />
                <strong>User benefit:</strong> Keep product catalog synchronized with current inventory.
              </div>
            </div>

            <div class="req-item complete" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                <span class="status-dot"></span>
                <div class="req-title" style="font-size: 14px;">leads_retrieval</div>
              </div>
              <div
                style="margin-left: 32px; margin-top: 8px; font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                <strong>Why we need it:</strong> To retrieve leads from Facebook Lead Ads for sales follow-up.<br />
                <strong>How we use it:</strong> GET /{page-id}/leadgen_forms ‚Üí GET
                /{form-id}/leads?fields=created_time,field_data.<br />
                <strong>Data accessed:</strong> Lead form submissions including name, email, phone (with user
                consent).<br />
                <strong>User benefit:</strong> Access qualified leads for wholesale customer acquisition.
              </div>
            </div>

          </div>

          <div
            style="margin-top: 20px; padding: 14px; background: rgba(24,119,242,0.08); border-radius: 10px; border: 1px solid rgba(24,119,242,0.2);">
            <p style="margin: 0; font-size: 12px; color: var(--text-main);">
              <strong>üîí Data Privacy:</strong> We only access data necessary for the features described above. We do
              not store Facebook data on external servers.
              All API calls are made client-side using the Facebook JavaScript SDK. Users can revoke access at any time
              via Facebook Settings ‚Üí Apps and Websites.
            </p>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="fb-logo">f</div>
        <div>
          <div style="font-size:15px;font-weight:600;">Continue as Yohanseh</div>
          <div style="font-size:12px;color:#6b7280;">Akonocap Command Center</div>
        </div>
      </div>
      <div class="modal-body">
        <p>Akonocap Command Center will receive access to your public profile, email address, and the following
          permissions:</p>
        <div class="modal-perms">
          <strong>Ads Management:</strong><br />
          ‚Ä¢ ads_read, ads_management ‚Äî View and manage your Facebook ads<br /><br />
          <strong>Pages:</strong><br />
          ‚Ä¢ pages_show_list ‚Äî View list of Pages you manage<br />
          ‚Ä¢ pages_manage_metadata ‚Äî Update Page settings and info<br />
          ‚Ä¢ pages_read_engagement ‚Äî View Page insights and metrics<br /><br />
          <strong>Messaging:</strong><br />
          ‚Ä¢ pages_messaging ‚Äî Respond to Page messages<br />
          ‚Ä¢ pages_utility_messaging ‚Äî Send order updates<br /><br />
          <strong>Business:</strong><br />
          ‚Ä¢ business_management ‚Äî Manage business assets<br /><br />
        </div>
        <p style="margin-top:10px;font-size:11px;color:#6b7280;">
          You can remove this connection at any time in your Meta account settings.
        </p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn-secondary" type="button" onclick="closeModal()">Cancel</button>
        <button class="modal-btn-primary" type="button" onclick="completeLogin()">Continue as Yohanseh</button>
      </div>
    </div>
  </div>

  <!-- DRAWER BACKDROP -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>

  <!-- CREATE INSTAGRAM POST DRAWER -->
  <aside id="postDrawer" class="drawer">
    <div class="drawer-header">
      <span>Create Instagram Post</span>
      <button class="drawer-close" type="button" onclick="closeDrawer('post')">√ó</button>
    </div>
    <div class="drawer-body">
      <div class="field-label">Connected Account</div>
      <div class="field-input" style="background:rgba(24,119,242,0.04);border-style:dashed;">
        @akonocap.bulkbuyers
      </div>

      <div class="field-label">Media</div>
      <div class="image-placeholder">
        Drop image or video here, or click to upload
      </div>

      <div class="field-label">Caption</div>
      <textarea class="field-textarea"
        placeholder="Example: Opening 20 bulk slots this week. DM BULK for pricing."></textarea>

      <div class="field-label">Publish Time</div>
      <input class="field-input" type="datetime-local" value="2025-01-01T15:00" />

      <div class="field-label">Post Type</div>
      <select class="field-input">
        <option>Feed Post</option>
        <option>Reel</option>
        <option>Story</option>
      </select>
    </div>
    <div class="drawer-footer">
      <button class="btn-ghost" type="button" onclick="closeDrawer('post')">Cancel</button>
      <button class="btn-primary" type="button" onclick="saveDraft()">Schedule Post</button>
    </div>
  </aside>

  <!-- CREATE CAMPAIGN DRAWER -->
  <aside id="campaignDrawer" class="drawer">
    <div class="drawer-header">
      <span>Create Facebook Campaign</span>
      <button class="drawer-close" type="button" onclick="closeDrawer('campaign')">√ó</button>
    </div>
    <div class="drawer-body">
      <div class="field-label">Ad Account</div>
      <div id="campaignAdAccount" class="field-input" style="background:rgba(24,119,242,0.04);border-style:dashed;">
        Select an ad account first
      </div>

      <div class="field-label">Campaign Objective</div>
      <select class="field-input">
        <option>Leads</option>
        <option>Sales</option>
        <option>Traffic</option>
        <option>Engagement</option>
      </select>

      <div class="field-label">Daily Budget (USD)</div>
      <input class="field-input" type="number" value="50" />

      <div class="field-label">Target Audience</div>
      <textarea class="field-textarea"
        placeholder="Example: US, age 18-35, interests in sneakers, streetwear, reselling."></textarea>

      <div class="field-label">Placements</div>
      <select class="field-input">
        <option>Automatic (recommended)</option>
        <option>Facebook & Instagram Feeds</option>
        <option>Instagram Only</option>
      </select>
    </div>
    <div class="drawer-footer">
      <button class="btn-ghost" type="button" onclick="closeDrawer('campaign')">Cancel</button>
      <button class="btn-primary" type="button" onclick="saveCampaign()">Create Campaign</button>
    </div>
  </aside>

  <!-- PAGE SETTINGS DRAWER -->
  <aside id="pageSettingsDrawer" class="drawer">
    <div class="drawer-header">
      <span>Manage Page Settings (pages_manage_metadata)</span>
      <button class="drawer-close" type="button" onclick="closeDrawer('pageSettings')">√ó</button>
    </div>
    <div class="drawer-body">
      <div class="field-label">Page ID</div>
      <input id="settingsPageId" class="field-input" type="text" readonly style="background: #f5f6f7;" />

      <div class="field-label">Page Name</div>
      <input id="settingsPageName" class="field-input" type="text" readonly style="background: #f5f6f7;" />

      <div class="field-label">About / Description</div>
      <textarea id="settingsAbout" class="field-textarea" placeholder="Page description..."></textarea>

      <div class="field-label">Website</div>
      <input id="settingsWebsite" class="field-input" type="text" placeholder="https://yourwebsite.com" />

      <div class="field-label">Phone</div>
      <input id="settingsPhone" class="field-input" type="text" placeholder="+1 (555) 123-4567" />

      <p style="font-size: 11px; color: var(--success); margin-top: 12px;">‚úì Changes are saved via the Pages API using
        pages_manage_metadata permission</p>
    </div>
    <div class="drawer-footer">
      <button class="btn-ghost" type="button" onclick="closeDrawer('pageSettings')">Cancel</button>
      <button class="btn-primary" type="button" onclick="savePageSettings()">Save Changes</button>
    </div>
  </aside>

  <!-- SEND MESSAGE DRAWER -->
  <aside id="sendMessageDrawer" class="drawer">
    <div class="drawer-header">
      <span>Send Message (pages_messaging)</span>
      <button class="drawer-close" type="button" onclick="closeDrawer('sendMessage')">√ó</button>
    </div>
    <div class="drawer-body">
      <!-- Messenger Verification Alert -->
      <div
        style="padding: 12px; border-radius: 10px; background: rgba(24,119,242,0.1); border: 1px solid rgba(24,119,242,0.3); margin-bottom: 12px;">
        <strong style="color: #1877f2;">üì± Verify in Messenger</strong>
        <p style="margin: 4px 0 0; font-size: 12px; color: #666;">After sending, open Facebook Messenger to confirm the
          message was delivered to the recipient.</p>
      </div>

      <div id="messageSentConfirm"
        style="display:none; padding: 12px; border-radius: 10px; background: rgba(22,163,74,0.1); border: 1px solid rgba(22,163,74,0.2); margin-bottom: 12px;">
        <strong style="color: #16a34a;">‚úì Message Sent Successfully</strong>
        <p style="margin: 4px 0 0; font-size: 12px; color: #666;">Now open Facebook Messenger to verify delivery.</p>
      </div>

      <div class="field-label">Select Page</div>
      <select id="messagePageSelect" class="field-input" onchange="loadPSIDsForPage('message')">
        <option value="">-- Select a Page --</option>
      </select>

      <div class="field-label">Recipient (Recent Conversations)</div>
      <select id="messageRecipient" class="field-input">
        <option value="">-- Select a Page first --</option>
      </select>
      <p style="font-size: 11px; color: #666; margin-top: -8px; margin-bottom: 12px;">Last 3 people who messaged your
        Page (loaded via API)</p>

      <div class="field-label">Message</div>
      <textarea id="messageText" class="field-textarea" placeholder="Type your response message here..."></textarea>
    </div>
    <div class="drawer-footer">
      <button class="btn-ghost" type="button" onclick="closeDrawer('sendMessage')">Cancel</button>
      <button class="btn-primary" type="button" onclick="sendPageMessage()">Send Message</button>
    </div>
  </aside>

  <!-- UTILITY MESSAGE DRAWER - WITH TEMPLATE SELECTION -->
  <aside id="utilityMessageDrawer" class="drawer" style="width: 500px;">
    <div class="drawer-header">
      <span>üìã Send Order Update (pages_utility_messaging)</span>
      <button class="drawer-close" type="button" onclick="closeDrawer('utilityMessage')">√ó</button>
    </div>
    <div class="drawer-body">
      <!-- STEP INDICATOR -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <div id="step1Indicator"
          style="flex:1; padding: 8px; background: #1877f2; color: white; border-radius: 8px; text-align: center; font-size: 11px; font-weight: 600;">
          1. Select Template
        </div>
        <div id="step2Indicator"
          style="flex:1; padding: 8px; background: #e4e6eb; color: #666; border-radius: 8px; text-align: center; font-size: 11px;">
          2. Fill Details
        </div>
        <div id="step3Indicator"
          style="flex:1; padding: 8px; background: #e4e6eb; color: #666; border-radius: 8px; text-align: center; font-size: 11px;">
          3. Send
        </div>
      </div>

      <!-- Non-Promotional Warning -->
      <div
        style="padding: 10px; border-radius: 8px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); margin-bottom: 12px;">
        <strong style="color: #dc2626; font-size: 11px;">‚ö†Ô∏è TRANSACTIONAL ONLY - No Promotional Content</strong>
        <p style="margin: 2px 0 0; font-size: 10px; color: #666;">
          Uses MESSAGE_TAG: POST_PURCHASE_UPDATE for order-related updates only.
        </p>
      </div>

      <div id="utilitySentConfirm"
        style="display:none; padding: 12px; border-radius: 10px; background: rgba(22,163,74,0.1); border: 1px solid rgba(22,163,74,0.2); margin-bottom: 12px;">
        <strong style="color: #16a34a;">‚úì Order Update Sent Successfully!</strong>
        <p style="margin: 4px 0 0; font-size: 12px; color: #666;">Now open Facebook Messenger to verify the message was
          delivered.</p>
      </div>

      <!-- STEP 1: TEMPLATE SELECTION -->
      <div id="templateSelectionStep">
        <div class="field-label" style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">
          üìù Step 1: Select a Message Template
        </div>

        <!-- Template Cards -->
        <div id="templateCards" style="display: flex; flex-direction: column; gap: 8px;">

          <!-- Template 1: Order Shipped -->
          <div class="template-card" onclick="selectTemplate('shipped')" id="template-shipped"
            style="padding: 12px; border: 2px solid #e4e6eb; border-radius: 10px; cursor: pointer; transition: all 0.15s ease; background: white;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 18px;">üì¶</span>
              <strong style="font-size: 13px;">Order Shipped</strong>
              <span
                style="margin-left: auto; padding: 2px 6px; background: #dbeafe; border-radius: 999px; font-size: 9px; color: #1e40af;">POST_PURCHASE_UPDATE</span>
            </div>
            <div
              style="font-size: 11px; color: #666; background: #f8fafc; padding: 8px; border-radius: 6px; font-family: monospace; line-height: 1.4;">
              Your order <span
                style="background: #fef3c7; padding: 1px 4px; border-radius: 3px;">{{order_number}}</span> has shipped!
              Tracking: <span
                style="background: #fef3c7; padding: 1px 4px; border-radius: 3px;">{{tracking_number}}</span>
            </div>
          </div>

          <!-- Template 2: Order Delivered -->
          <div class="template-card" onclick="selectTemplate('delivered')" id="template-delivered"
            style="padding: 12px; border: 2px solid #e4e6eb; border-radius: 10px; cursor: pointer; transition: all 0.15s ease; background: white;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 18px;">‚úÖ</span>
              <strong style="font-size: 13px;">Order Delivered</strong>
              <span
                style="margin-left: auto; padding: 2px 6px; background: #dbeafe; border-radius: 999px; font-size: 9px; color: #1e40af;">POST_PURCHASE_UPDATE</span>
            </div>
            <div
              style="font-size: 11px; color: #666; background: #f8fafc; padding: 8px; border-radius: 6px; font-family: monospace; line-height: 1.4;">
              Your order <span
                style="background: #fef3c7; padding: 1px 4px; border-radius: 3px;">{{order_number}}</span> has been
              delivered. Thank you!
            </div>
          </div>

          <!-- Template 3: Order Confirmed -->
          <div class="template-card" onclick="selectTemplate('confirmed')" id="template-confirmed"
            style="padding: 12px; border: 2px solid #e4e6eb; border-radius: 10px; cursor: pointer; transition: all 0.15s ease; background: white;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 18px;">üßæ</span>
              <strong style="font-size: 13px;">Order Confirmed</strong>
              <span
                style="margin-left: auto; padding: 2px 6px; background: #dbeafe; border-radius: 999px; font-size: 9px; color: #1e40af;">POST_PURCHASE_UPDATE</span>
            </div>
            <div
              style="font-size: 11px; color: #666; background: #f8fafc; padding: 8px; border-radius: 6px; font-family: monospace; line-height: 1.4;">
              Your order <span
                style="background: #fef3c7; padding: 1px 4px; border-radius: 3px;">{{order_number}}</span> is confirmed
              and being prepared.
            </div>
          </div>

        </div>

        <p style="font-size: 10px; color: #666; margin-top: 10px; text-align: center;">
          Click a template to select it and proceed to fill in placeholders
        </p>
      </div>

      <!-- STEP 2: FILL PLACEHOLDERS (Initially Hidden) -->
      <div id="fillPlaceholdersStep" style="display: none;">
        <div class="field-label" style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">
          ‚úèÔ∏è Step 2: Fill in Placeholder Values
        </div>

        <div
          style="padding: 10px; background: rgba(24,119,242,0.05); border-radius: 8px; border: 1px solid rgba(24,119,242,0.2); margin-bottom: 12px;">
          <div style="font-size: 11px; color: #1877f2; font-weight: 600;">Selected Template:</div>
          <div id="selectedTemplateName" style="font-size: 13px; font-weight: 600; margin-top: 2px;"></div>
        </div>

        <div class="field-label">Select Page</div>
        <select id="utilityPageSelect" class="field-input" onchange="loadPSIDsForPage('utility')">
          <option value="">-- Select a Page --</option>
        </select>

        <div class="field-label">Recipient (Customer)</div>
        <select id="utilityRecipient" class="field-input" onchange="checkManualPSID()">
          <option value="">-- Select a Page first --</option>
        </select>
        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
          <span style="font-size: 11px; color: #666;">Or enter PSID manually:</span>
        </div>
        <input id="manualPSID" class="field-input" type="text" placeholder="Enter PSID (e.g., 25237327232600073)"
          oninput="useManualPSID()" />
        <p style="font-size: 10px; color: #666; margin-top: -8px; margin-bottom: 10px;">PSID of customer who messaged
          your Page</p>

        <div class="field-label">Order Number <span style="color: #dc2626;">*</span></div>
        <input id="utilityOrderNum" class="field-input" type="text" placeholder="#12345"
          oninput="updateTemplatePreview()" />

        <div id="trackingField">
          <div class="field-label">Tracking Number</div>
          <input id="utilityTracking" class="field-input" type="text" placeholder="1Z999AA10123456784"
            oninput="updateTemplatePreview()" />
        </div>

        <div class="field-label" style="margin-top: 12px;">üì± Message Preview</div>
        <div id="utilityPreview"
          style="padding: 12px; background: #f0fff4; border-radius: 8px; font-size: 12px; border: 2px solid #16a34a; line-height: 1.5;">
          Select a template and fill in the placeholders above
        </div>
        <p style="font-size: 10px; color: #16a34a; margin: 6px 0 0;">‚úì POST_PURCHASE_UPDATE - Transactional only</p>

        <div style="display: flex; gap: 8px; margin-top: 14px;">
          <button class="btn-ghost" type="button" onclick="backToTemplates()" style="flex: 1;">‚Üê Back</button>
          <button class="btn-primary" type="button" onclick="goToSendStep()" style="flex: 1;">Preview & Send ‚Üí</button>
        </div>
      </div>

      <!-- STEP 3: CONFIRM & SEND (Initially Hidden) -->
      <div id="sendStep" style="display: none;">
        <div class="field-label" style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">
          üöÄ Step 3: Review & Send
        </div>

        <div style="padding: 10px; background: rgba(24,119,242,0.1); border-radius: 8px; margin-bottom: 12px;">
          <strong style="color: #1877f2; font-size: 12px;">üì± Verify in Messenger After Sending</strong>
          <p style="margin: 4px 0 0; font-size: 11px; color: #666;">
            Open Facebook Messenger after sending to confirm delivery.
          </p>
        </div>

        <div class="field-label">Sending To:</div>
        <div id="sendToSummary"
          style="padding: 8px; background: #f5f6f7; border-radius: 8px; margin-bottom: 10px; font-size: 12px;"></div>

        <div class="field-label">Final Message:</div>
        <div id="finalMessagePreview"
          style="padding: 12px; background: white; border-radius: 8px; font-size: 12px; border: 2px solid #16a34a; line-height: 1.5; margin-bottom: 10px;">
        </div>

        <div style="padding: 8px; background: rgba(22,163,74,0.1); border-radius: 8px; margin-bottom: 14px;">
          <div style="font-size: 10px; color: #16a34a; font-family: monospace;">
            POST /{page-id}/messages<br>
            messaging_type: MESSAGE_TAG<br>
            tag: POST_PURCHASE_UPDATE
          </div>
        </div>

        <div style="display: flex; gap: 8px;">
          <button class="btn-ghost" type="button" onclick="backToFillStep()" style="flex: 1;">‚Üê Edit</button>
          <button class="btn-primary" type="button" onclick="sendUtilityMessage()"
            style="flex: 1; background: #16a34a;">üì§ Send Update</button>
        </div>
      </div>

    </div>
  </aside>

  <script>
    // Global state
    let accessToken = null;
    let pages = [];
    let adAccounts = [];

    // Handle API errors - check for invalid/expired tokens
    function handleApiError(response) {
      if (response.error) {
        const errorCode = response.error.code;
        const errorMsg = response.error.message || 'Unknown error';

        // Token errors: 190 = invalid token, 102 = session expired, 463 = token expired
        if (errorCode === 190 || errorCode === 102 || errorCode === 463 ||
          errorMsg.includes('session') || errorMsg.includes('token') || errorMsg.includes('invalidated')) {
          alert('Your Facebook session has expired. Please reconnect your account.');
          facebookLogout();
          return true; // Error was handled
        }
        return false; // Error not handled
      }
      return false;
    }

    // DOM Elements
    const loginBtn = document.getElementById("loginBtn");
    const userPanel = document.getElementById("userPanel");
    const adsPanel = document.getElementById("adsPanel");
    const pagesPanel = document.getElementById("pagesPanel");
    const messagingPanel = document.getElementById("messagingPanel");
    const instagramPanel = document.getElementById("instagramPanel");
    const leadsPanel = document.getElementById("leadsPanel");
    const catalogPanel = document.getElementById("catalogPanel");
    const postsAdsPanel = document.getElementById("postsAdsPanel");
    const businessPanel = document.getElementById("businessPanel");
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const themeLabel = document.getElementById("themeLabel");
    const adsLoading = document.getElementById("adsLoading");
    const loadBtn = document.getElementById("loadBtn");
    const createCampaignBtn = document.getElementById("createCampaignBtn");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const adAccountSelect = document.getElementById("adAccountSelect");
    const campaignAdAccount = document.getElementById("campaignAdAccount");

    // Facebook Login - REAL OAuth Flow
    function facebookLogin() {
      FB.login(function (response) {
        if (response.authResponse) {
          onFBConnected(response.authResponse);
        } else {
          alert('Facebook login was cancelled or failed.');
        }
      }, {
        scope: 'public_profile,pages_show_list,pages_manage_metadata,pages_read_engagement,pages_messaging,pages_utility_messaging,pages_manage_posts,pages_manage_ads,business_management,ads_read,ads_management,instagram_basic,instagram_business_basic,instagram_business_manage_messages,instagram_content_publish,instagram_manage_comments,instagram_manage_messages,catalog_management,leads_retrieval',
        return_scopes: true
      });
    }

    // On Facebook Connected
    function onFBConnected(authResponse) {
      accessToken = authResponse.accessToken;

      // Update UI
      loginBtn.style.display = "none";
      userPanel.classList.add("visible");

      // Enable all panels
      adsPanel.classList.remove("disabled");
      pagesPanel.classList.remove("disabled");
      messagingPanel.classList.remove("disabled");
      businessPanel.classList.remove("disabled");
      if (instagramPanel) instagramPanel.classList.remove("disabled");
      if (leadsPanel) leadsPanel.classList.remove("disabled");
      if (catalogPanel) catalogPanel.classList.remove("disabled");
      if (postsAdsPanel) postsAdsPanel.classList.remove("disabled");

      // Load user info (public_profile)
      FB.api('/me', { fields: 'id,name,picture' }, function (response) {
        if (handleApiError(response)) return;
        if (response && !response.error) {
          document.querySelector('.user-name').textContent = response.name;
          const userIdEl = document.querySelector('.user-id');
          if (userIdEl) {
            userIdEl.textContent = response.id ? `ID: ${response.id}` : 'ID: --';
          }
          if (response.picture && response.picture.data) {
            document.querySelector('.user-avatar').src = response.picture.data.url;
          }
        }
      });

      // Load pages (pages_show_list)
      loadPages();

      // Load ad accounts (business_management)
      loadAdAccounts();

      // Load catalogs (catalog_management)
      loadCatalogs();
    }

    // Facebook Logout
    function facebookLogout() {
      FB.logout(function (response) {
        accessToken = null;
        pages = [];
        userPanel.classList.remove("visible");
        loginBtn.style.display = "inline-flex";
        adsPanel.classList.add("disabled");
        pagesPanel.classList.add("disabled");
        messagingPanel.classList.add("disabled");
        businessPanel.classList.add("disabled");
      });
    }

    // Load Pages (pages_show_list)
    function loadPages() {
      FB.api('/me/accounts', {
        fields: 'id,name,access_token,picture,fan_count,category,instagram_business_account{id,username}'
      }, function (response) {
        if (handleApiError(response)) return;

        if (response && response.data) {
          pages = response.data;
          renderPagesList();
          populatePageSelects();

          // Load engagement for first page (pages_read_engagement)
          if (pages.length > 0) {
            loadPageEngagement(pages[0].id, pages[0].access_token);
            loadConversations(pages[0].id, pages[0].access_token);
          }
        }
      });
    }

    // Render Pages List
    function renderPagesList() {
      const container = document.getElementById('pagesList');
      if (!container) return;

      container.innerHTML = '';
      pages.forEach(page => {
        const pic = page.picture && page.picture.data ? page.picture.data.url : '';
        container.innerHTML += `
          <div class="page-card">
            <div class="page-avatar">${pic ? '<img src="' + pic + '" alt="">' : page.name.charAt(0)}</div>
            <div class="page-info">
              <div class="page-name">${page.name}</div>
              <div class="page-stats">${page.fan_count ? page.fan_count.toLocaleString() + ' followers ‚Ä¢ ' : ''}${page.category || 'Page'}</div>
            </div>
            <button class="btn-ghost" onclick="openPageSettings('${page.id}')">Manage</button>
          </div>
        `;
      });
    }

    // Populate Page Selects
    function populatePageSelects() {
      const selects = ['messagePageSelect', 'utilityPageSelect'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
          select.innerHTML = '<option value="">-- Select a Page --</option>';
          pages.forEach(page => {
            select.innerHTML += `<option value="${page.id}" data-token="${page.access_token}">${page.name}</option>`;
          });
        }
      });
    }

    // Load Page Engagement (pages_read_engagement)
    function loadPageEngagement(pageId, pageToken) {
      FB.api('/' + pageId + '/insights', {
        metric: 'page_views_total,page_post_engagements,page_fan_adds',
        period: 'week',
        access_token: pageToken
      }, function (response) {
        if (handleApiError(response)) return;
        if (response && response.data) {
          response.data.forEach(metric => {
            const value = metric.values && metric.values[0] ? metric.values[0].value : 0;
            const el = document.querySelector(`[data-metric="${metric.name}"]`);
            if (el) el.textContent = value.toLocaleString();
          });
        }
      });
    }

    // Store messages globally for tab switching
    let allMessages = { inbox: [], sent: [], utility: [] };
    let currentPageInfo = { id: null, token: null, name: null };

    // Load Conversations (pages_messaging)
    function loadConversations(pageId, pageToken) {
      currentPageInfo = { id: pageId, token: pageToken };

      // Find page name
      const page = pages.find(p => p.id === pageId);
      if (page) currentPageInfo.name = page.name;

      FB.api('/' + pageId + '/conversations', {
        fields: 'participants,messages.limit(10){message,from,created_time}',
        access_token: pageToken,
        limit: 10
      }, function (response) {
        if (handleApiError(response)) return;

        // Reset messages
        allMessages = { inbox: [], sent: [], utility: [] };

        if (response && response.data && response.data.length > 0) {
          response.data.forEach(conv => {
            const participants = conv.participants?.data || [];
            const customer = participants.find(p => p.id !== pageId);
            const messages = conv.messages?.data || [];

            messages.forEach(msg => {
              const isFromPage = msg.from?.id === pageId;
              const msgObj = {
                sender: msg.from?.name || 'Unknown',
                senderId: msg.from?.id,
                text: msg.message || '',
                time: msg.created_time,
                customer: customer?.name || 'Unknown',
                customerId: customer?.id
              };

              if (isFromPage) {
                // Message sent BY the page
                allMessages.sent.push(msgObj);
              } else {
                // Message received FROM customer
                allMessages.inbox.push(msgObj);
              }
            });
          });
        }

        // Update inbox count
        updateInboxCount();

        // Show inbox by default
        showMessageTab('inbox');
      });
    }

    // Update inbox count in tab
    function updateInboxCount() {
      const inboxTab = document.querySelector('.tab[data-tab="inbox"]');
      if (inboxTab) {
        inboxTab.textContent = `Inbox (${allMessages.inbox.length})`;
      }
    }

    // Show messages for specific tab
    function showMessageTab(tab) {
      const container = document.getElementById('conversationsList');
      if (!container) return;

      const messages = allMessages[tab] || [];

      container.innerHTML = '';

      if (messages.length > 0) {
        // Show last 3 messages, most recent first
        const recentMessages = messages.slice(0, 3);
        recentMessages.forEach(msg => {
          const timeAgo = getTimeAgo(msg.time);
          const icon = tab === 'sent' ? '‚ÜóÔ∏è Sent to' : (tab === 'utility' ? 'üì¶ Update to' : 'üì© From');
          const displayName = tab === 'inbox' ? msg.sender : msg.customer;

          container.innerHTML += `
            <div class="message-preview" style="border-left: 3px solid ${tab === 'inbox' ? '#1877f2' : (tab === 'sent' ? '#16a34a' : '#f59e0b')};">
              <div class="message-sender">${icon} ${displayName}</div>
              <div class="message-text">"${msg.text.substring(0, 80)}${msg.text.length > 80 ? '...' : ''}"</div>
              <div class="message-time">${timeAgo}</div>
            </div>
          `;
        });
      } else {
        const emptyMsg = tab === 'inbox' ? 'No messages received yet' :
          (tab === 'sent' ? 'No messages sent yet' : 'No utility messages sent yet');
        container.innerHTML = `<div class="message-preview"><div class="message-sender">No messages</div><div class="message-text">${emptyMsg}</div></div>`;
      }
    }

    // Helper: Get relative time
    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }

    // Switch message tabs
    function switchMessageTab(tab) {
      // Update active tab styling
      document.querySelectorAll('#messagingTabs .tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.tab === tab) t.classList.add('active');
      });

      // Show messages for selected tab
      showMessageTab(tab);
    }

    // Add sent message to local tracking
    function trackSentMessage(recipientName, recipientId, message, isUtility) {
      const msgObj = {
        sender: currentPageInfo.name || 'Page',
        senderId: currentPageInfo.id,
        text: message,
        time: new Date().toISOString(),
        customer: recipientName,
        customerId: recipientId
      };

      if (isUtility) {
        allMessages.utility.unshift(msgObj);
      } else {
        allMessages.sent.unshift(msgObj);
      }
    }

    // Load PSIDs for message recipient dropdown (last 3 conversations)
    function loadPSIDsForPage(type) {
      const pageSelect = document.getElementById(type === 'message' ? 'messagePageSelect' : 'utilityPageSelect');
      const recipientSelect = document.getElementById(type === 'message' ? 'messageRecipient' : 'utilityRecipient');
      const pageId = pageSelect.value;
      const pageToken = pageSelect.options[pageSelect.selectedIndex]?.dataset?.token;

      // Reset dropdown
      recipientSelect.innerHTML = '<option value="">Loading conversations...</option>';

      if (!pageId || !pageToken) {
        recipientSelect.innerHTML = '<option value="">-- Select a Page first --</option>';
        return;
      }

      // Fetch conversations to get PSIDs
      FB.api('/' + pageId + '/conversations', {
        fields: 'participants,messages.limit(1){message,from,created_time}',
        access_token: pageToken,
        limit: 3
      }, function (response) {
        if (handleApiError(response)) {
          recipientSelect.innerHTML = '<option value="">Error loading - reconnect</option>';
          return;
        }

        recipientSelect.innerHTML = '<option value="">-- Select recipient --</option>';

        if (response && response.data && response.data.length > 0) {
          response.data.forEach((conv, index) => {
            // Get the participant who is NOT the page
            const participants = conv.participants?.data || [];
            const customer = participants.find(p => p.id !== pageId);
            const lastMsg = conv.messages?.data?.[0];

            if (customer) {
              const preview = lastMsg?.message ? lastMsg.message.substring(0, 30) + '...' : '';
              recipientSelect.innerHTML += `<option value="${customer.id}">${customer.name} (${preview})</option>`;
            }
          });

          if (recipientSelect.options.length === 1) {
            recipientSelect.innerHTML = '<option value="">No conversations found</option>';
          }
        } else {
          recipientSelect.innerHTML = '<option value="">No conversations found - someone must message your Page first</option>';
        }
      });
    }

    // Send Page Message (pages_messaging)
    function sendPageMessage() {
      const pageSelect = document.getElementById('messagePageSelect');
      const pageId = pageSelect.value;
      const pageToken = pageSelect.options[pageSelect.selectedIndex].dataset.token;
      const recipientSelect = document.getElementById('messageRecipient');
      const recipient = recipientSelect.value;
      const recipientName = recipientSelect.options[recipientSelect.selectedIndex]?.text || 'Customer';
      const message = document.getElementById('messageText').value;

      if (!pageId || !recipient || !message) {
        alert('Please fill in all fields');
        return;
      }

      FB.api('/' + pageId + '/messages', 'POST', {
        recipient: { id: recipient },
        message: { text: message },
        messaging_type: 'RESPONSE',
        access_token: pageToken
      }, function (response) {
        if (response && response.message_id) {
          document.getElementById('messageSentConfirm').style.display = 'block';
          document.getElementById('messageText').value = '';

          // Track sent message locally
          trackSentMessage(recipientName.split(' (')[0], recipient, message, false);

          alert('‚úì Message sent! ID: ' + response.message_id + '\n\nNow open Facebook Messenger to verify delivery.');
        } else {
          if (!handleApiError(response)) {
            alert('Error: ' + (response.error ? response.error.message : 'Failed to send'));
          }
        }
      });
    }

    // Template Selection State
    let selectedTemplate = null;
    const templateMessages = {
      shipped: 'Your order {{order_number}} has shipped! Tracking number: {{tracking_number}}. Estimated delivery: 3-5 business days.',
      delivered: 'Great news! Your order {{order_number}} has been delivered. Thank you for your purchase!',
      confirmed: 'Your order {{order_number}} is confirmed! We are preparing it for shipment. You will receive tracking information soon.'
    };
    const templateNames = {
      shipped: 'üì¶ Order Shipped',
      delivered: '‚úÖ Order Delivered',
      confirmed: 'üßæ Order Confirmed'
    };

    // Select Template (Step 1)
    function selectTemplate(type) {
      selectedTemplate = type;

      // Update visual selection
      document.querySelectorAll('.template-card').forEach(card => {
        card.style.borderColor = '#e4e6eb';
        card.style.background = 'white';
      });
      const selectedCard = document.getElementById('template-' + type);
      if (selectedCard) {
        selectedCard.style.borderColor = '#1877f2';
        selectedCard.style.background = 'rgba(24,119,242,0.05)';
      }

      // Show/hide tracking field based on template
      const trackingField = document.getElementById('trackingField');
      if (trackingField) {
        trackingField.style.display = (type === 'shipped') ? 'block' : 'none';
      }

      // Update selected template name
      const templateNameEl = document.getElementById('selectedTemplateName');
      if (templateNameEl) {
        templateNameEl.textContent = templateNames[type];
      }

      // Move to step 2 after a brief delay
      setTimeout(() => {
        goToFillStep();
      }, 300);
    }

    // Go to Fill Step (Step 2)
    function goToFillStep() {
      const step1 = document.getElementById('templateSelectionStep');
      const step2 = document.getElementById('fillPlaceholdersStep');
      const step3 = document.getElementById('sendStep');

      if (step1) step1.style.display = 'none';
      if (step2) step2.style.display = 'block';
      if (step3) step3.style.display = 'none';

      // Update step indicators
      const ind1 = document.getElementById('step1Indicator');
      const ind2 = document.getElementById('step2Indicator');
      const ind3 = document.getElementById('step3Indicator');
      if (ind1) { ind1.style.background = '#16a34a'; ind1.style.color = 'white'; }
      if (ind2) { ind2.style.background = '#1877f2'; ind2.style.color = 'white'; }
      if (ind3) { ind3.style.background = '#e4e6eb'; ind3.style.color = '#666'; }

      updateTemplatePreview();
    }

    // Back to Templates (Step 1)
    function backToTemplates() {
      const step1 = document.getElementById('templateSelectionStep');
      const step2 = document.getElementById('fillPlaceholdersStep');
      const step3 = document.getElementById('sendStep');

      if (step1) step1.style.display = 'block';
      if (step2) step2.style.display = 'none';
      if (step3) step3.style.display = 'none';

      // Update step indicators
      const ind1 = document.getElementById('step1Indicator');
      const ind2 = document.getElementById('step2Indicator');
      if (ind1) { ind1.style.background = '#1877f2'; ind1.style.color = 'white'; }
      if (ind2) { ind2.style.background = '#e4e6eb'; ind2.style.color = '#666'; }
    }

    // Go to Send Step (Step 3)
    function goToSendStep() {
      const pageSelect = document.getElementById('utilityPageSelect');
      const orderNum = document.getElementById('utilityOrderNum')?.value;
      const recipient = getRecipientPSID();

      if (!pageSelect?.value) {
        alert('Please select a Page');
        return;
      }
      if (!recipient) {
        alert('Please select a recipient from dropdown or enter a PSID manually');
        return;
      }
      if (!orderNum) {
        alert('Please enter an order number');
        return;
      }

      const step1 = document.getElementById('templateSelectionStep');
      const step2 = document.getElementById('fillPlaceholdersStep');
      const step3 = document.getElementById('sendStep');

      if (step1) step1.style.display = 'none';
      if (step2) step2.style.display = 'none';
      if (step3) step3.style.display = 'block';

      // Update step indicators
      const ind1 = document.getElementById('step1Indicator');
      const ind2 = document.getElementById('step2Indicator');
      const ind3 = document.getElementById('step3Indicator');
      if (ind1) { ind1.style.background = '#16a34a'; }
      if (ind2) { ind2.style.background = '#16a34a'; }
      if (ind3) { ind3.style.background = '#1877f2'; ind3.style.color = 'white'; }

      // Update send summary
      const pageName = pageSelect.options[pageSelect.selectedIndex]?.text || 'Page';
      const summaryEl = document.getElementById('sendToSummary');
      const finalPreviewEl = document.getElementById('finalMessagePreview');
      const utilityPreviewEl = document.getElementById('utilityPreview');

      if (summaryEl) summaryEl.innerHTML = `<strong>Page:</strong> ${pageName}<br><strong>Customer:</strong> ${recipient.name}<br><strong>PSID:</strong> <code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;">${recipient.id}</code>`;
      if (finalPreviewEl && utilityPreviewEl) finalPreviewEl.textContent = utilityPreviewEl.textContent;
    }

    // Back to Fill Step (from Step 3)
    function backToFillStep() {
      goToFillStep();
    }

    // Update Template Preview with placeholders filled in
    function updateTemplatePreview() {
      if (!selectedTemplate) return;

      const orderNumEl = document.getElementById('utilityOrderNum');
      const trackingEl = document.getElementById('utilityTracking');
      const previewEl = document.getElementById('utilityPreview');

      const orderNum = orderNumEl?.value || '{{order_number}}';
      const tracking = trackingEl?.value || '{{tracking_number}}';

      let message = templateMessages[selectedTemplate] || '';
      message = message.replace('{{order_number}}', orderNum);
      message = message.replace('{{tracking_number}}', tracking);

      if (previewEl) previewEl.textContent = message;
    }

    // Legacy function for compatibility
    function updateUtilityPreview() {
      if (selectedTemplate) {
        updateTemplatePreview();
        return;
      }
      // Fallback for old flow
      const typeEl = document.getElementById('utilityType');
      const orderNumEl = document.getElementById('utilityOrderNum');
      const trackingEl = document.getElementById('utilityTracking');
      const previewEl = document.getElementById('utilityPreview');

      if (!typeEl || !previewEl) return;

      const type = typeEl.value;
      const orderNum = orderNumEl?.value || '#[order]';
      const tracking = trackingEl?.value || '[tracking]';

      let preview = '';
      switch (type) {
        case 'shipped':
          preview = `Your order ${orderNum} has shipped. Tracking number: ${tracking}. Estimated delivery: 3-5 business days.`;
          break;
        case 'delivered':
          preview = `Your order ${orderNum} has been delivered.`;
          break;
        case 'confirmed':
          preview = `Payment received. Your order ${orderNum} is confirmed and being prepared for shipment.`;
          break;
      }
      previewEl.textContent = preview;
    }

    // Manual PSID handling
    function useManualPSID() {
      const manualInput = document.getElementById('manualPSID');
      const selectDropdown = document.getElementById('utilityRecipient');

      if (manualInput && manualInput.value.trim()) {
        // Clear dropdown selection when manual PSID is entered
        if (selectDropdown) selectDropdown.value = '';
      }
    }

    function checkManualPSID() {
      const manualInput = document.getElementById('manualPSID');
      const selectDropdown = document.getElementById('utilityRecipient');

      if (selectDropdown && selectDropdown.value) {
        // Clear manual input when dropdown is selected
        if (manualInput) manualInput.value = '';
      }
    }

    // Get the recipient PSID (from dropdown or manual input)
    function getRecipientPSID() {
      const manualInput = document.getElementById('manualPSID');
      const selectDropdown = document.getElementById('utilityRecipient');

      // Prefer manual input if filled
      if (manualInput && manualInput.value.trim()) {
        return {
          id: manualInput.value.trim(),
          name: 'Customer (PSID: ' + manualInput.value.trim().substring(0, 8) + '...)'
        };
      }

      // Otherwise use dropdown
      if (selectDropdown && selectDropdown.value) {
        return {
          id: selectDropdown.value,
          name: selectDropdown.options[selectDropdown.selectedIndex]?.text || 'Customer'
        };
      }

      return null;
    }

    // Send Utility Message (pages_utility_messaging)
    function sendUtilityMessage() {
      const pageSelect = document.getElementById('utilityPageSelect');
      const pageId = pageSelect.value;
      const pageToken = pageSelect.options[pageSelect.selectedIndex].dataset.token;
      const recipient = getRecipientPSID();
      const message = document.getElementById('utilityPreview').textContent;

      if (!pageId) {
        alert('Please select a page');
        return;
      }

      if (!recipient) {
        alert('Please select a recipient or enter a PSID manually');
        return;
      }

      console.log('Sending utility message to PSID:', recipient.id);
      console.log('Message:', message);

      FB.api('/' + pageId + '/messages', 'POST', {
        recipient: { id: recipient.id },
        message: { text: message },
        messaging_type: 'MESSAGE_TAG',
        tag: 'POST_PURCHASE_UPDATE',
        access_token: pageToken
      }, function (response) {
        if (response && response.message_id) {
          document.getElementById('utilitySentConfirm').style.display = 'block';

          // Track utility message locally
          trackSentMessage(recipient.name.split(' (')[0], recipient.id, message, true);

          alert('‚úì Order update sent successfully!\n\nMessage ID: ' + response.message_id + '\n\nPSID: ' + recipient.id + '\n\nNow open Facebook Messenger to verify delivery.');
        } else {
          if (!handleApiError(response)) {
            alert('Error: ' + (response.error ? response.error.message : 'Failed to send'));
          }
        }
      });
    }

    // Load Ad Accounts (business_management)
    function loadAdAccounts() {
      FB.api('/me/adaccounts', { fields: 'id,name,account_status' }, function (response) {
        if (handleApiError(response)) return;
        if (response && response.data) {
          adAccounts = response.data;
          adAccountSelect.innerHTML = '<option>-- Select ad account --</option>';
          adAccounts.forEach(acc => {
            adAccountSelect.innerHTML += `<option value="${acc.id}">${acc.name || acc.id}</option>`;
          });
        }
      });
    }

    // Load Ad Insights (ads_read)
    function loadAdInsights() {
      const accountId = adAccountSelect.value;
      if (!accountId || accountId === '-- Select ad account --') {
        alert('Please select an ad account');
        return;
      }

      adsLoading.classList.add("visible");

      // 1. Fetch Account-level Insights
      FB.api('/' + accountId + '/insights', {
        fields: 'spend,impressions,clicks,actions',
        date_preset: 'last_7d'
      }, function (response) {
        adsLoading.classList.remove("visible");
        if (handleApiError(response)) return;

        if (response && response.data && response.data[0]) {
          const data = response.data[0];
          const spend = parseFloat(data.spend || 0);
          const impressions = parseInt(data.impressions || 0);

          // Calculate Leads (actions with value 'lead')
          let leads = 0;
          if (data.actions) {
            data.actions.forEach(action => {
              if (action.action_type === 'lead' || action.action_type === 'contact' || action.action_type === 'landing_page_view') {
                leads += parseInt(action.value);
              }
            });
          }

          // Calculate CPL
          const cpl = leads > 0 ? (spend / leads) : 0;

          // Update UI with IDs
          const spendEl = document.getElementById('adInsightsAccSpend');
          const impEl = document.getElementById('adInsightsAccImpressions');
          const cplEl = document.getElementById('adInsightsAccCPL');

          if (spendEl) spendEl.textContent = '$' + spend.toFixed(2);
          if (impEl) impEl.textContent = impressions.toLocaleString();
          if (cplEl) cplEl.textContent = cpl > 0 ? '$' + cpl.toFixed(2) : '$ -';
        }
      });

      // 2. Load Campaigns for this account
      loadActiveCampaigns(accountId);
    }

    // Load Active Campaigns
    function loadActiveCampaigns(accountId) {
      const container = document.getElementById('campaignsList');
      if (!container) return;

      container.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-muted);"><div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> Loading campaigns...</div>';

      // Fetch Campaign Insights directly to get metrics + names
      FB.api('/' + accountId + '/insights', {
        level: 'campaign',
        fields: 'campaign_name,campaign_id,spend,impressions,actions,objective,buying_type',
        date_preset: 'last_7d',
        limit: 5
      }, function (response) {
        if (handleApiError(response)) return;

        container.innerHTML = '';

        if (response && response.data && response.data.length > 0) {
          response.data.forEach(camp => {
            const spend = parseFloat(camp.spend || 0);

            // Calculate Leads/CPL for this campaign
            let leads = 0;
            if (camp.actions) {
              camp.actions.forEach(action => {
                if (action.action_type === 'lead' || action.action_type === 'contact') {
                  leads += parseInt(action.value);
                }
              });
            }
            const cpl = leads > 0 ? (spend / leads) : 0;

            // Status/Meta string
            const meta = `Active | ${leads} Leads | ${camp.objective || ' conversions'}`;

            container.innerHTML += `
              <div class="list-item">
                <div>
                  <div class="list-title">${camp.campaign_name}</div>
                  <div class="list-meta">${meta}</div>
                </div>
                <span class="pill">${cpl > 0 ? 'CPL $' + cpl.toFixed(2) : 'Spend $' + spend.toFixed(0)}</span>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-muted);">No active campaigns in last 7 days</div>';
        }
      });
    }

    // Open Page Settings (pages_manage_metadata)
    function openPageSettings(pageId) {
      const page = pages.find(p => p.id === pageId);
      if (page) {
        document.getElementById('settingsPageId').value = page.id;
        document.getElementById('settingsPageName').value = page.name;

        FB.api('/' + pageId, {
          fields: 'about,website,phone',
          access_token: page.access_token
        }, function (response) {
          if (response) {
            document.getElementById('settingsAbout').value = response.about || '';
            document.getElementById('settingsWebsite').value = response.website || '';
            document.getElementById('settingsPhone').value = response.phone || '';
          }
        });

        openDrawer('pageSettings');
      }
    }

    // Save Page Settings (pages_manage_metadata)
    function savePageSettings() {
      const pageId = document.getElementById('settingsPageId').value;
      const page = pages.find(p => p.id === pageId);
      if (!page) return;

      FB.api('/' + pageId, 'POST', {
        about: document.getElementById('settingsAbout').value,
        website: document.getElementById('settingsWebsite').value,
        phone: document.getElementById('settingsPhone').value,
        access_token: page.access_token
      }, function (response) {
        if (response && response.success) {
          alert('‚úì Page settings updated successfully!');
          closeDrawer('pageSettings');
          loadPages();
        } else {
          alert('Error: ' + (response.error ? response.error.message : 'Failed to update'));
        }
      });
    }

    // Theme toggle
    themeToggle.addEventListener("click", () => {
      const body = document.body;
      const dark = body.classList.contains("theme-dark");
      if (dark) {
        body.classList.remove("theme-dark");
        body.classList.add("theme-light");
        themeIcon.textContent = "üåô";
        themeLabel.textContent = "Dark";
      } else {
        body.classList.remove("theme-light");
        body.classList.add("theme-dark");
        themeIcon.textContent = "‚òÄÔ∏è";
        themeLabel.textContent = "Light";
      }
    });

    // Load insights button
    loadBtn.addEventListener("click", loadAdInsights);

    // Drawer helpers
    function openDrawer(which) {
      drawerBackdrop.classList.add("visible");
      const drawer = document.getElementById(which + "Drawer");
      if (drawer) drawer.classList.add("visible");
    }

    function closeDrawer(which) {
      const allDrawers = document.querySelectorAll('.drawer');
      allDrawers.forEach(d => d.classList.remove('visible'));
      drawerBackdrop.classList.remove("visible");
    }

    function saveDraft() {
      closeDrawer('post');
      alert("‚úì Instagram post scheduled successfully!");
    }

    function saveCampaign() {
      closeDrawer('campaign');
      alert("‚úì Facebook campaign created successfully!");
    }

    drawerBackdrop.addEventListener("click", () => closeDrawer());
    // createPostBtn.addEventListener("click", () => openDrawer("post")); // Instagram - coming soon
    createCampaignBtn.addEventListener("click", () => openDrawer("campaign"));

    // Tab switching (for non-messaging tabs only - messaging tabs have onclick handlers)
    document.querySelectorAll('.tabs:not(#messagingTabs) .tab').forEach(tab => {
      tab.addEventListener('click', function () {
        this.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Initialize
    updateUtilityPreview();

    // ========== INSTAGRAM FUNCTIONS (instagram_basic, instagram_business_basic, instagram_content_publish, instagram_manage_comments, instagram_business_manage_messages) ==========

    let instagramAccounts = [];
    let currentIgAccount = null;
    let igMedia = [];
    let selectedIgMedia = null;
    let selectedIgComment = null;

    // Load Instagram accounts from Pages - populate dropdown
    function loadInstagramAccounts() {
      instagramAccounts = [];
      const igPageSelect = document.getElementById('igPageSelect');

      if (!igPageSelect) return;

      // Reset dropdown
      igPageSelect.innerHTML = '<option value="">-- Select a Facebook Page --</option>';

      // Hide account info and no account message initially
      document.getElementById('igAccountInfo').style.display = 'none';
      document.getElementById('igNoAccount').style.display = 'none';

      // Populate dropdown with Pages that have Instagram accounts connected
      pages.forEach(page => {
        const hasIg = page.instagram_business_account ? true : false;
        const igInfo = hasIg ? ` (@${page.instagram_business_account.username})` : ' (No IG connected)';

        if (hasIg) {
          instagramAccounts.push({
            igId: page.instagram_business_account.id,
            igUsername: page.instagram_business_account.username,
            pageId: page.id,
            pageToken: page.access_token,
            pageName: page.name
          });
        }

        // Add to dropdown - all pages, but indicate which have IG
        igPageSelect.innerHTML += `<option value="${page.id}" data-hasig="${hasIg}">${page.name}${igInfo}</option>`;
      });

      // Reset media list
      const mediaList = document.getElementById('igMediaList');
      if (mediaList) {
        mediaList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); grid-column: 1/-1;">Select a Facebook Page to view its connected Instagram account</div>';
      }
    }

    // Handle Page selection for Instagram
    function onIgPageSelected() {
      const igPageSelect = document.getElementById('igPageSelect');
      const pageId = igPageSelect?.value;

      // Hide both sections initially
      document.getElementById('igAccountInfo').style.display = 'none';
      document.getElementById('igNoAccount').style.display = 'none';

      if (!pageId) {
        // No page selected - show default message
        const mediaList = document.getElementById('igMediaList');
        if (mediaList) {
          mediaList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); grid-column: 1/-1;">Select a Facebook Page to view its connected Instagram account</div>';
        }
        currentIgAccount = null;
        return;
      }

      // Find the page
      const page = pages.find(p => p.id === pageId);
      if (!page) return;

      // Check if this page has an Instagram account connected
      if (page.instagram_business_account) {
        // Has IG - load it
        const igAccount = {
          igId: page.instagram_business_account.id,
          igUsername: page.instagram_business_account.username,
          pageId: page.id,
          pageToken: page.access_token,
          pageName: page.name
        };
        loadInstagramData(igAccount);
      } else {
        // No IG connected to this page
        document.getElementById('igNoAccount').style.display = 'block';
        currentIgAccount = null;

        // Clear media
        const mediaList = document.getElementById('igMediaList');
        if (mediaList) {
          mediaList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); grid-column: 1/-1;">No Instagram account connected to this Page</div>';
        }

        // Clear engagement cards
        document.getElementById('igFollowers').textContent = '--';
        document.getElementById('igPosts').textContent = '--';
        document.getElementById('igEngagement').textContent = '--';
        document.getElementById('igReach').textContent = '--';
      }
    }

    // Load Instagram data (instagram_basic, instagram_business_basic)
    function loadInstagramData(igAccount) {
      currentIgAccount = igAccount;
      const igLoading = document.getElementById('igLoading');
      if (igLoading) igLoading.classList.add('visible');

      FB.api('/' + igAccount.igId, {
        fields: 'id,username,profile_picture_url,followers_count,media_count,biography',
        access_token: igAccount.pageToken
      }, function (response) {
        if (igLoading) igLoading.classList.remove('visible');
        if (handleApiError(response)) return;

        if (response && !response.error) {
          // Update account info
          document.getElementById('igAccountInfo').style.display = 'block';
          document.getElementById('igUsername').textContent = '@' + response.username;
          document.getElementById('igStats').textContent = (response.followers_count || 0).toLocaleString() + ' followers ‚Ä¢ ' + (response.media_count || 0) + ' posts';
          if (response.profile_picture_url) {
            document.getElementById('igProfilePic').src = response.profile_picture_url;
          }

          // Update engagement cards
          document.getElementById('igFollowers').textContent = (response.followers_count || 0).toLocaleString();
          document.getElementById('igFollowersDelta').textContent = 'Total followers';
          document.getElementById('igPosts').textContent = response.media_count || 0;

          // Load media
          loadInstagramMedia(igAccount);

          // Load insights
          loadInstagramInsights(igAccount);
        }
      });
    }

    // Load Instagram media (instagram_business_basic)
    function loadInstagramMedia(igAccount) {
      FB.api('/' + igAccount.igId + '/media', {
        fields: 'id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,like_count,comments_count',
        limit: 9,
        access_token: igAccount.pageToken
      }, function (response) {
        if (handleApiError(response)) return;

        const container = document.getElementById('igMediaList');
        if (!container) return;

        container.innerHTML = '';
        igMedia = [];

        if (response && response.data && response.data.length > 0) {
          igMedia = response.data;
          response.data.forEach((media, index) => {
            const imgUrl = media.thumbnail_url || media.media_url || '';
            const typeIcon = media.media_type === 'VIDEO' ? 'üé¨' : (media.media_type === 'CAROUSEL_ALBUM' ? 'üì∑' : '');
            container.innerHTML += `
              <div onclick="selectIgMedia(${index})" style="aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; border: 2px solid transparent; transition: all 0.15s ease;" id="igMedia-${index}">
                <img src="${imgUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; justify-content: space-between; font-size: 10px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
                  <span>‚ù§Ô∏è ${media.like_count || 0}</span>
                  <span>üí¨ ${media.comments_count || 0}</span>
                </div>
                ${typeIcon ? `<div style="position: absolute; top: 4px; right: 4px; font-size: 14px;">${typeIcon}</div>` : ''}
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); grid-column: 1/-1;">No posts yet</div>';
        }
      });
    }

    // Load Instagram insights (instagram_business_basic)
    function loadInstagramInsights(igAccount) {
      FB.api('/' + igAccount.igId + '/insights', {
        metric: 'reach,impressions',
        period: 'day',
        access_token: igAccount.pageToken
      }, function (response) {
        if (response && response.data) {
          response.data.forEach(metric => {
            if (metric.name === 'reach') {
              const value = metric.values && metric.values[0] ? metric.values[0].value : 0;
              document.getElementById('igReach').textContent = value.toLocaleString();
            }
          });
        }
      });
    }

    // Select Instagram media for comment management
    function selectIgMedia(index) {
      selectedIgMedia = igMedia[index];

      // Update visual selection
      document.querySelectorAll('[id^="igMedia-"]').forEach(el => {
        el.style.borderColor = 'transparent';
      });
      const selected = document.getElementById('igMedia-' + index);
      if (selected) selected.style.borderColor = '#1877f2';

      // Load comments for this media
      loadIgComments(selectedIgMedia.id);
    }

    // Load Instagram comments (instagram_manage_comments)
    function loadIgComments(mediaId) {
      if (!currentIgAccount) return;

      FB.api('/' + mediaId + '/comments', {
        fields: 'id,text,username,timestamp,like_count',
        access_token: currentIgAccount.pageToken
      }, function (response) {
        const container = document.getElementById('igCommentsList');
        if (!container) return;

        container.innerHTML = '';

        if (response && response.data && response.data.length > 0) {
          response.data.forEach(comment => {
            const timeAgo = getTimeAgo(comment.timestamp);
            container.innerHTML += `
              <div class="message-preview" style="border-left: 3px solid #d62976;" onclick="selectIgComment('${comment.id}', '${comment.username}')">
                <div class="message-sender">@${comment.username}</div>
                <div class="message-text">"${comment.text}"</div>
                <div class="message-time">${timeAgo} ‚Ä¢ ‚ù§Ô∏è ${comment.like_count || 0}</div>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div class="message-preview"><div class="message-sender">No comments</div><div class="message-text">This post has no comments yet</div></div>';
        }
      });
    }

    // Select comment for reply
    function selectIgComment(commentId, username) {
      selectedIgComment = { id: commentId, username: username };
      const replyInput = document.getElementById('igReplyText');
      if (replyInput) {
        replyInput.placeholder = `Reply to @${username}...`;
        replyInput.focus();
      }
    }

    // Reply to Instagram comment (instagram_manage_comments)
    function replyToIgComment() {
      if (!selectedIgComment || !currentIgAccount) {
        alert('Please select a comment to reply to');
        return;
      }

      const replyText = document.getElementById('igReplyText').value;
      if (!replyText.trim()) {
        alert('Please enter a reply');
        return;
      }

      FB.api('/' + selectedIgComment.id + '/replies', 'POST', {
        message: replyText,
        access_token: currentIgAccount.pageToken
      }, function (response) {
        if (response && response.id) {
          alert('‚úì Reply posted successfully!');
          document.getElementById('igReplyText').value = '';
          loadIgComments(selectedIgMedia.id);
        } else {
          if (!handleApiError(response)) {
            alert('Error: ' + (response.error ? response.error.message : 'Failed to post reply'));
          }
        }
      });
    }

    // Switch Instagram tabs
    function switchIgTab(tab) {
      document.querySelectorAll('#instagramTabs .tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.tab === tab) t.classList.add('active');
      });

      document.getElementById('igMediaSection').style.display = tab === 'media' ? 'block' : 'none';
      document.getElementById('igCommentsSection').style.display = tab === 'comments' ? 'block' : 'none';
      document.getElementById('igMessagesSection').style.display = tab === 'messages' ? 'block' : 'none';

      if (tab === 'messages') {
        loadInstagramDMs();
      }
    }

    // Load Instagram DMs (instagram_business_manage_messages, instagram_manage_messages)
    function loadInstagramDMs() {
      if (!currentIgAccount) return;

      const container = document.getElementById('igDMList');
      if (!container) return;

      FB.api('/' + currentIgAccount.igId + '/conversations', {
        fields: 'participants,messages.limit(1){message,from,created_time}',
        platform: 'instagram',
        access_token: currentIgAccount.pageToken,
        limit: 5
      }, function (response) {
        container.innerHTML = '';

        if (response && response.data && response.data.length > 0) {
          response.data.forEach(conv => {
            const lastMsg = conv.messages?.data?.[0];
            const participant = conv.participants?.data?.find(p => p.id !== currentIgAccount.igId);

            if (lastMsg) {
              const timeAgo = getTimeAgo(lastMsg.created_time);
              container.innerHTML += `
                <div class="message-preview" style="border-left: 3px solid #962fbf;">
                  <div class="message-sender">üì© ${participant?.name || 'Instagram User'}</div>
                  <div class="message-text">"${lastMsg.message?.substring(0, 60) || ''}${lastMsg.message?.length > 60 ? '...' : ''}"</div>
                  <div class="message-time">${timeAgo}</div>
                </div>
              `;
            }
          });
        } else {
          container.innerHTML = '<div class="message-preview"><div class="message-sender">No DMs</div><div class="message-text">No Instagram Direct Messages found</div></div>';
        }
      });
    }

    // ========== LEADS FUNCTIONS (leads_retrieval) ==========

    let leadForms = [];
    let currentLeads = [];

    // Load lead forms (leads_retrieval, pages_manage_ads)
    function loadLeadForms() {
      const pageSelect = document.getElementById('leadsPageSelect');
      const pageId = pageSelect?.value;

      if (!pageId) return;

      const page = pages.find(p => p.id === pageId);
      if (!page) return;

      FB.api('/' + pageId + '/leadgen_forms', {
        fields: 'id,name,status,leads_count',
        access_token: page.access_token
      }, function (response) {
        if (handleApiError(response)) return;

        leadForms = response?.data || [];

        const container = document.getElementById('leadsList');
        if (!container) return;

        container.innerHTML = '';

        if (leadForms.length > 0) {
          leadForms.forEach(form => {
            container.innerHTML += `
              <div class="list-item" onclick="loadLeadsFromForm('${form.id}', '${page.access_token}')">
                <div>
                  <div class="list-title">${form.name}</div>
                  <div class="list-meta">${form.status} ‚Ä¢ ${form.leads_count || 0} leads</div>
                </div>
                <span class="pill">${form.leads_count || 0} leads</span>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-muted);">No lead forms found for this Page</div>';
        }
      });
    }

    // Load leads from a form (leads_retrieval)
    function loadLeadsFromForm(formId, pageToken) {
      const leadsLoading = document.getElementById('leadsLoading');
      if (leadsLoading) leadsLoading.classList.add('visible');

      FB.api('/' + formId + '/leads', {
        fields: 'created_time,field_data',
        access_token: pageToken,
        limit: 10
      }, function (response) {
        if (leadsLoading) leadsLoading.classList.remove('visible');
        if (handleApiError(response)) return;

        currentLeads = response?.data || [];

        const container = document.getElementById('leadsList');
        if (!container) return;

        container.innerHTML = '';

        if (currentLeads.length > 0) {
          // Update stats
          document.getElementById('leadsTotal').textContent = currentLeads.length;

          const today = new Date().toDateString();
          const todayLeads = currentLeads.filter(l => new Date(l.created_time).toDateString() === today);
          document.getElementById('leadsToday').textContent = todayLeads.length;

          currentLeads.forEach(lead => {
            const timeAgo = getTimeAgo(lead.created_time);
            const fields = lead.field_data || [];
            const name = fields.find(f => f.name === 'full_name' || f.name === 'first_name')?.values?.[0] || 'Lead';
            const email = fields.find(f => f.name === 'email')?.values?.[0] || '';

            container.innerHTML += `
              <div class="list-item">
                <div>
                  <div class="list-title">üìã ${name}</div>
                  <div class="list-meta">${email || 'No email'} ‚Ä¢ ${timeAgo}</div>
                </div>
                <span class="pill">New</span>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-muted);">No leads found in this form</div>';
        }
      });
    }

    // Load leads button handler
    function loadLeads() {
      const pageSelect = document.getElementById('leadsPageSelect');
      if (!pageSelect?.value) {
        alert('Please select a Page first');
        return;
      }
      loadLeadForms();
    }

    // Export leads to CSV
    function exportLeads() {
      if (currentLeads.length === 0) {
        alert('No leads to export. Load leads first.');
        return;
      }

      let csv = 'Name,Email,Phone,Created\n';
      currentLeads.forEach(lead => {
        const fields = lead.field_data || [];
        const name = fields.find(f => f.name === 'full_name' || f.name === 'first_name')?.values?.[0] || '';
        const email = fields.find(f => f.name === 'email')?.values?.[0] || '';
        const phone = fields.find(f => f.name === 'phone_number')?.values?.[0] || '';
        csv += `"${name}","${email}","${phone}","${lead.created_time}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'facebook_leads_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
    }

    // ========== CATALOG FUNCTIONS (catalog_management) ==========

    let catalogs = [];
    let catalogProducts = [];

    // Load catalogs (catalog_management)
    function loadCatalogs() {
      FB.api('/me/businesses', {
        fields: 'id,name,owned_product_catalogs{id,name,product_count}'
      }, function (response) {
        if (handleApiError(response)) return;

        const catalogSelect = document.getElementById('catalogSelect');
        if (!catalogSelect) return;

        catalogSelect.innerHTML = '<option value="">-- Select Catalog --</option>';
        catalogs = [];

        if (response && response.data) {
          response.data.forEach(business => {
            if (business.owned_product_catalogs && business.owned_product_catalogs.data) {
              business.owned_product_catalogs.data.forEach(catalog => {
                catalogs.push(catalog);
                catalogSelect.innerHTML += `<option value="${catalog.id}">${catalog.name} (${catalog.product_count || 0} products)</option>`;
              });
            }
          });
        }
      });
    }

    // Load catalog products (catalog_management)
    function loadCatalogProducts() {
      const catalogSelect = document.getElementById('catalogSelect');
      const catalogId = catalogSelect?.value;

      if (!catalogId) return;

      const catalogLoading = document.getElementById('catalogLoading');
      if (catalogLoading) catalogLoading.classList.add('visible');

      FB.api('/' + catalogId + '/products', {
        fields: 'id,name,description,price,currency,image_url,availability',
        limit: 10
      }, function (response) {
        if (catalogLoading) catalogLoading.classList.remove('visible');
        if (handleApiError(response)) return;

        catalogProducts = response?.data || [];

        const container = document.getElementById('catalogList');
        if (!container) return;

        container.innerHTML = '';

        if (catalogProducts.length > 0) {
          // Update stats
          document.getElementById('catalogTotal').textContent = catalogProducts.length;
          const active = catalogProducts.filter(p => p.availability === 'in stock').length;
          document.getElementById('catalogActive').textContent = active;
          document.getElementById('catalogPending').textContent = catalogProducts.length - active;

          catalogProducts.forEach(product => {
            const price = product.price ? (parseFloat(product.price) / 100).toFixed(2) : '0.00';
            const status = product.availability === 'in stock' ? '‚úÖ' : '‚è≥';

            container.innerHTML += `
              <div class="list-item">
                <div style="display: flex; align-items: center; gap: 10px;">
                  ${product.image_url ? `<img src="${product.image_url}" style="width: 40px; height: 40px; border-radius: 6px; object-fit: cover;">` : ''}
                  <div>
                    <div class="list-title">${product.name || 'Untitled'}</div>
                    <div class="list-meta">${status} ${product.availability || 'Unknown'}</div>
                  </div>
                </div>
                <span class="pill">$${price}</span>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-muted);">No products in catalog</div>';
        }
      });
    }

    // Sync catalog (placeholder)
    function syncCatalog() {
      alert('Catalog sync initiated. This would update product availability from your inventory system.');
    }

    // ========== PAGE POSTS & ADS FUNCTIONS (pages_manage_posts, pages_manage_ads) ==========

    let pagePosts = [];
    let currentPostsTab = 'posts';

    // Load page posts (pages_manage_posts)
    function loadPagePosts() {
      const pageSelect = document.getElementById('postsPageSelect');
      const pageId = pageSelect?.value;

      if (!pageId) return;

      const page = pages.find(p => p.id === pageId);
      if (!page) return;

      FB.api('/' + pageId + '/feed', {
        fields: 'id,message,created_time,shares,reactions.summary(true),comments.summary(true),is_published,scheduled_publish_time',
        access_token: page.access_token,
        limit: 10
      }, function (response) {
        if (handleApiError(response)) return;

        pagePosts = response?.data || [];
        showPagePostsTab(currentPostsTab);
      });
    }

    // Show posts for specific tab
    function showPagePostsTab(tab) {
      const container = document.getElementById('pagePostsList');
      if (!container) return;

      container.innerHTML = '';

      let posts = pagePosts;

      if (tab === 'scheduled') {
        posts = pagePosts.filter(p => !p.is_published && p.scheduled_publish_time);
      } else if (tab === 'boosted') {
        // Would need additional API call to check promotion status
        posts = posts.slice(0, 3); // Placeholder
      }

      if (posts.length > 0) {
        posts.forEach(post => {
          const timeAgo = getTimeAgo(post.created_time);
          const message = post.message ? post.message.substring(0, 60) + (post.message.length > 60 ? '...' : '') : 'No text';
          const reactions = post.reactions?.summary?.total_count || 0;
          const comments = post.comments?.summary?.total_count || 0;
          const shares = post.shares?.count || 0;

          container.innerHTML += `
            <div class="list-item">
              <div>
                <div class="list-title">${message}</div>
                <div class="list-meta">${timeAgo} ‚Ä¢ ‚ù§Ô∏è ${reactions} ‚Ä¢ üí¨ ${comments} ‚Ä¢ üîÑ ${shares}</div>
              </div>
              <button class="btn-ghost" onclick="boostPost('${post.id}')">Boost</button>
            </div>
          `;
        });
      } else {
        const emptyMsg = tab === 'posts' ? 'No posts yet' : (tab === 'scheduled' ? 'No scheduled posts' : 'No boosted posts');
        container.innerHTML = `<div class="list-item" style="justify-content: center; color: var(--text-muted);">${emptyMsg}</div>`;
      }
    }

    // Switch posts tabs
    function switchPostsTab(tab) {
      currentPostsTab = tab;
      document.querySelectorAll('#postsAdsTabs .tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.tab === tab) t.classList.add('active');
      });
      showPagePostsTab(tab);
    }

    // Boost post (pages_manage_ads)
    function boostPost(postId) {
      alert('This would open a dialog to boost post: ' + postId + '\n\nUsing pages_manage_ads permission to create a promotion.');
    }

    // ========== UPDATED populatePageSelects ==========

    // Override populatePageSelects to include new dropdowns
    const originalPopulatePageSelects = populatePageSelects;
    populatePageSelects = function () {
      const selects = ['messagePageSelect', 'utilityPageSelect', 'leadsPageSelect', 'postsPageSelect'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
          select.innerHTML = '<option value="">-- Select a Page --</option>';
          pages.forEach(page => {
            select.innerHTML += `<option value="${page.id}" data-token="${page.access_token}">${page.name}</option>`;
          });
        }
      });

      // Also load Instagram accounts after pages are populated
      loadInstagramAccounts();
    };

    // ========== UPDATED facebookLogout ==========

    const originalFacebookLogout = facebookLogout;
    facebookLogout = function () {
      FB.logout(function (response) {
        accessToken = null;
        pages = [];
        userPanel.classList.remove("visible");
        loginBtn.style.display = "inline-flex";
        adsPanel.classList.add("disabled");
        pagesPanel.classList.add("disabled");
        messagingPanel.classList.add("disabled");
        businessPanel.classList.add("disabled");
        if (instagramPanel) instagramPanel.classList.add("disabled");
        if (leadsPanel) leadsPanel.classList.add("disabled");
        if (catalogPanel) catalogPanel.classList.add("disabled");
        if (postsAdsPanel) postsAdsPanel.classList.add("disabled");
      });
    };
  </script>
</body>

</html>