<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Akonocap Command Center — App Review Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f0f2f5;
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      --border-subtle: #dadde1;
      --text-main: #050505;
      --text-muted: #606770;
      --accent: #1877f2;
      --accent-soft: rgba(24, 119, 242, 0.1);
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-strong: 0 12px 30px rgba(0, 0, 0, 0.12);
      --pill-bg: #e4e6eb;
      --overlay: rgba(255, 255, 255, 0.7);
      --success: #16a34a;
      --warning: #f59e0b;
    }

    body.theme-dark {
      --bg: #050816;
      --bg-card: #111827;
      --bg-header: #020617;
      --border-subtle: #1f2933;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --accent: #1d9bf0;
      --accent-soft: rgba(29, 155, 240, 0.12);
      --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 18px 40px rgba(0, 0, 0, 0.7);
      --pill-bg: #1f2937;
      --overlay: rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e3ebff 0, #f0f2f5 40%, var(--bg) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .shell {
      width: 100%;
      max-width: 1400px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px 12px 24px;
    }

    header {
      padding: 12px 18px;
      border-radius: 14px;
      background: var(--bg-header);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-pill {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #1877f2, #42b72a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9);
    }

    .app-name {
      font-size: 20px;
      font-weight: 600;
    }

    .tagline {
      font-size: 12px;
      color: var(--text-muted);
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .grid {
      width: 100%;
      max-width: 1380px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .panel {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .panel.full-span {
      grid-column: 1 / -1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .demo-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .caption-overlay {
      position: fixed;
      bottom: 24px;
      right: 24px;
      max-width: 420px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid var(--border-subtle);
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: var(--shadow-strong);
      z-index: 120;
      display: none;
      font-size: 13px;
      color: var(--text-main);
    }

    .caption-overlay.visible {
      display: block;
      animation: fadeIn 0.18s ease-out;
    }

    .caption-step {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .caption-note {
      font-size: 13px;
      color: var(--text-muted);
    }

    .screencast-overlay {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 115;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .screencast-overlay.visible {
      display: flex;
      pointer-events: auto;
    }

    .screencast-highlight {
      border: 2px dashed rgba(24, 119, 242, 0.9);
      border-radius: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.95);
      max-width: 820px;
      width: calc(100% - 48px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    .pages-list {
      display: grid;
      gap: 8px;
      margin-top: 12px;
    }

    .page-item {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.02), transparent);
    }

    .engagement-card {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      margin-top: 10px;
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.02), transparent);
    }

    .note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .sr-only {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.96);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="theme-light">
  <!-- Facebook SDK -->
  <script>
    // fbAsyncInit will be called by SDK once loaded
    window.fbAsyncInit = function () {
      FB.init({
        appId: '1185063939768948',
        cookie: true,
        xfbml: true,
        version: 'v24.0'
      });
      // If reviewer already has a session, we show connected state and allow continuing
      FB.getLoginStatus(function (response) {
        if (response.status === 'connected') {
          onFBConnected(response.authResponse);
        }
      });
    };
  </script>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

  <div class="shell">
    <!-- HEADER -->
    <header>
      <div>
        <div class="brand-row">
          <div class="logo-pill">A</div>
          <div class="app-name">Akonocap Command Center</div>
        </div>
        <div class="tagline">Unified management for Facebook Ads, Pages, Messaging, and Instagram content.</div>
      </div>
      <div>
        <!-- Visible and explicit callout for App Review steps -->
        <button class="btn-primary" id="start-screencast-btn" onclick="startScreencast()" aria-label="Start demo screencast">Start App Review Screencast</button>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- Left column: normal app UI (truncated for brevity), plus new App Review Demo panel -->
        <div class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">App Review Demo</div>
              <div class="panel-sub">Interactive demo that shows the end-to-end flow requested by app review: user login, permissions consent, selecting a Page, and reading Page engagement (pages_read_engagement).</div>
            </div>
          </div>

          <div class="demo-controls" aria-hidden="false">
            <button class="btn-primary" id="demo-login-btn" onclick="startLoginFlow()">Click to login and grant permissions</button>
            <button class="btn-primary" id="demo-reset-btn" onclick="resetDemo()" style="background:#6b7280">Reset demo</button>
            <div class="note">Important: When you press the first button, the Facebook Login dialog will appear (this demonstrates the frontend Meta login flow). Please accept the permissions to continue.</div>
          </div>

          <div id="demo-state" aria-live="polite">
            <!-- Dynamic demo content appears here -->
            <div id="connected-info" style="display:none">
              <div class="sr-only" id="sr-connected">Facebook connected.</div>
              <div class="panel-sub">Connected as: <span id="user-name"></span></div>
              <div>
                <button class="btn-primary" onclick="listPages()">Show Pages I manage</button>
              </div>
              <div id="pages-container" style="margin-top:12px"></div>
            </div>

            <div id="not-connected" style="display:block">
              <div class="note">Reviewer instructions (English): 1) Click "Click to login and grant permissions". 2) In the Facebook dialog, accept the requested permissions (we specifically request <code>pages_read_engagement</code> and <code>pages_show_list</code>). 3) Select a Page when prompted. 4) The demo will show Page posts and engagement counts to demonstrate read access to Page content. Captions and tooltips will appear during the screencast.</div>
            </div>
          </div>
        </div>

        <!-- Right column: additional info / screenshots / guidance for the reviewer -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">App Review Guidance (for reviewers)</div>
          </div>
          <div class="panel-sub">What this demo shows</div>
          <ul>
            <li>Frontend Meta login flow is visible (FB login dialog opens in the browser).</li>
            <li>User grants <code>pages_read_engagement</code> and <code>pages_show_list</code> (both requested in the dialog).</li>
            <li>The demo lists Pages the user manages and reads recent posts and engagement counts to demonstrate read access.</li>
            <li>All captions and guidance are in English and visible in the UI and as aria-live announcements.</li>
          </ul>

          <div class="note">If you need a test Page or account, please use the Facebook test-user or test Page provided in your App Dashboard. This demo expects a reviewer to accept the login dialog to show the end-to-end flow. If your submission uses a server-to-server token only, indicate that separately in the submission notes; this demo intentionally demonstrates the frontend login flow so the login UI is visible to reviewers.</div>
        </div>

        <!-- Full-width panel with results/engagement -->
        <div class="panel full-span">
          <div class="panel-header">
            <div class="panel-title">Page engagement readout</div>
          </div>
          <div id="engagement-output">
            <div class="note">No page selected. Use the demo controls to sign in and select a Page.</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Caption overlay used during the screencast to explicitly narrate steps and highlight what to click/accept. Visible and in English. -->
  <div class="caption-overlay" id="caption" role="status" aria-live="polite" aria-atomic="true">
    <div class="caption-step" id="caption-step">Ready</div>
    <div class="caption-note" id="caption-note">Press "Start App Review Screencast" to begin. The UI will walk you through the Meta login flow, permission consent, Page selection, and reading Page content (pages_read_engagement).</div>
  </div>

  <!-- Screencast highlight overlay (lightbox) -->
  <div class="screencast-overlay" id="screencast-overlay" aria-hidden="true">
    <div class="screencast-highlight" id="screencast-highlight" role="dialog" aria-label="Screencast demo highlight">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">App Review Screencast</div>
        <div><button onclick="endScreencast()" style="border:none;background:#ef4444;color:white;padding:6px 10px;border-radius:6px;cursor:pointer">End</button></div>
      </div>
      <div id="screencast-body" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    // Helper to update caption overlay (visible and accessible)
    function setCaption(step, note) {
      const c = document.getElementById('caption');
      document.getElementById('caption-step').textContent = step;
      document.getElementById('caption-note').textContent = note;
      c.classList.add('visible');
      // keep visible for screen recording clarity
    }

    function clearCaption() {
      const c = document.getElementById('caption');
      c.classList.remove('visible');
    }

    // Start the high-level screencast: shows overlay and walks through steps with instructions
    function startScreencast() {
      document.getElementById('screencast-overlay').classList.add('visible');
      document.getElementById('screencast-overlay').setAttribute('aria-hidden', 'false');
      document.getElementById('screencast-body').innerHTML = `
        <div style="font-size:14px;font-weight:600">Step 1 — Show the Meta login dialog</div>
        <div style="margin-top:8px;color:var(--text-muted)">Click the "Click to login and grant permissions" button to open the Facebook login dialog. When the dialog appears, accept the requested permissions (pages_show_list, pages_read_engagement).</div>
        <div style="margin-top:12px"><button class="btn-primary" onclick="startLoginFlow()">Open Login Dialog</button></div>
      `;
      setCaption('Screencast started', 'We will show the full frontend Meta login flow and then demonstrate reading Page posts and engagement. All guidance is in English.');
    }

    function endScreencast() {
      document.getElementById('screencast-overlay').classList.remove('visible');
      document.getElementById('screencast-overlay').setAttribute('aria-hidden', 'true');
      setCaption('Screencast ended', 'You can restart if needed. The demo remains interactive.');
      // auto-clear caption after short delay so the recording shows the final state
      setTimeout(clearCaption, 6000);
    }

    function resetDemo() {
      // clear UI
      document.getElementById('connected-info').style.display = 'none';
      document.getElementById('not-connected').style.display = 'block';
      document.getElementById('pages-container').innerHTML = '';
      document.getElementById('engagement-output').innerHTML = '<div class="note">No page selected. Use the demo controls to sign in and select a Page.</div>';
      document.getElementById('user-name').textContent = '';
      setCaption('Demo reset', 'The demo UI has been reset. Press "Click to login and grant permissions" to restart.');
    }

    // Start the login flow — this will open the official FB login dialog so reviewers can see the flow
    function startLoginFlow() {
      setCaption('Opening login dialog', 'Please accept the requested permissions in the dialog. We request pages_show_list and pages_read_engagement (English captions are shown).');
      // request the permissions reviewers need to see: pages_show_list & pages_read_engagement
      const scopes = 'pages_show_list,pages_read_engagement';
      // Call FB.login — this will open the Meta dialog
      if (typeof FB === 'undefined') {
        alert('Facebook SDK not loaded. Please ensure the SDK can load in the reviewer environment.');
        return;
      }
      FB.login(function (response) {
        if (response.status === 'connected') {
          onFBConnected(response.authResponse);
          setCaption('Login successful', 'Connected. Showing Pages you manage next.');
        } else {
          setCaption('Login not completed', 'If the dialog was dismissed, please re-run the screencast and accept the permissions.');
        }
      }, { scope: scopes, return_scopes: true });
    }

    // Called after successful FB login
    function onFBConnected(authResponse) {
      // show username and options
      FB.api('/me', { fields: 'name' }, function (res) {
        document.getElementById('user-name').textContent = res.name || res.id || 'Facebook user';
        document.getElementById('connected-info').style.display = 'block';
        document.getElementById('not-connected').style.display = 'none';
        setCaption('Connected as ' + (res.name || 'user'), 'Click "Show Pages I manage" to list Pages accessible with pages_show_list. Then select a Page to show posts and engagement counts.');
      });
    }

    // List pages the user manages (requires pages_show_list)
    function listPages() {
      setCaption('Listing pages', 'Retrieving Pages via /me/accounts to demonstrate pages_show_list and pages_read_engagement usage.');
      document.getElementById('pages-container').innerHTML = '<div class="note">Loading pages…</div>';
      FB.api('/me/accounts', { fields: 'name,access_token,category' }, function (res) {
        if (!res || res.error) {
          document.getElementById('pages-container').innerHTML = '<div class="note">Unable to list pages. Please ensure the reviewer accepted pages_show_list permission in the login dialog.</div>';
          setCaption('Unable to list pages', 'If pages do not appear, ensure the login dialog granted pages_show_list.');
          return;
        }
        if (!res.data || res.data.length === 0) {
          document.getElementById('pages-container').innerHTML = '<div class="note">No Pages found for this account. Please use an account that manages at least one Page.</div>';
          setCaption('No Pages found', 'Please sign in with a Page admin account to continue.');
          return;
        }
        const container = document.getElementById('pages-container');
        container.innerHTML = '';
        const list = document.createElement('div');
        list.className = 'pages-list';
        res.data.forEach(function (pg) {
          const item = document.createElement('div');
          item.className = 'page-item';
          item.innerHTML = `<div>
              <div style="font-weight:600">${escapeHtml(pg.name)}</div>
              <div style="font-size:12px;color:var(--text-muted)">${escapeHtml(pg.category || '')}</div>
            </div>
            <div>
              <button class="btn-primary" onclick="selectPage('${encodeURIComponent(pg.id)}')">Select</button>
            </div>`;
          // attach data via dataset for later
          item.dataset.pageId = pg.id;
          list.appendChild(item);
        });
        container.appendChild(list);
        setCaption('Pages listed', 'Select a Page to demonstrate reading Page content (posts) and engagement metrics.');
      });
    }

    // Select a page — read recent posts and show engagement counts (requires pages_read_engagement)
    function selectPage(pageIdEncoded) {
      const pageId = decodeURIComponent(pageIdEncoded);
      setCaption('Reading Page posts', 'We will call /{page-id}/posts and read engagement counts (pages_read_engagement). Demonstrates allowed usage: reading content posted by the Page and engagement info.');
      document.getElementById('engagement-output').innerHTML = '<div class="note">Loading posts and engagement…</div>';
      // First we attempt to read posts (this will succeed only if pages_read_engagement was granted)
      FB.api(`/${pageId}/posts`, { fields: 'message,created_time,id,insights.metric(post_impressions,post_engaged_users){values}' , limit: 5 }, function (res) {
        if (!res || res.error) {
          // Provide a clear explanation for reviewers if permission is missing
          document.getElementById('engagement-output').innerHTML = `<div class="note">Unable to read posts or engagement. This usually means <strong>pages_read_engagement</strong> was not granted in the login dialog. Please re-run the demo and accept the permission so I can show the end-to-end flow.</div>`;
          setCaption('Permission required', 'pages_read_engagement must be accepted in the login dialog to show Page posts and engagement metrics.');
          return;
        }
        // Build UI showing posts and high-level engagement info
        const out = document.getElementById('engagement-output');
        out.innerHTML = '';
        const header = document.createElement('div');
        header.style.marginBottom = '8px';
        header.innerHTML = `<div style="font-weight:700">Recent posts for the selected Page</div>
                            <div style="font-size:12px;color:var(--text-muted)">This demonstrates reading Page content and engagement. IDs and timestamps are shown as examples.</div>`;
        out.appendChild(header);

        (res.data || []).forEach(function (post) {
          const card = document.createElement('div');
          card.className = 'engagement-card';
          const msg = post.message ? escapeHtml(post.message) : '(no message)';
          const created = post.created_time ? new Date(post.created_time).toLocaleString('en-US', { timeZone: 'UTC' }) : '';
          // Attempt to get a simple engagement metric if available from insights
          let engaged = '';
          if (post.insights && post.insights.data && post.insights.data.length > 0) {
            // try to pick post_engaged_users value
            const engagedMetric = post.insights.data.find(m => m.name && m.name.indexOf('post_engaged_users') !== -1);
            if (engagedMetric && engagedMetric.values && engagedMetric.values[0]) {
              engaged = engagedMetric.values[0].value || '';
            }
          }
          card.innerHTML = `<div style="font-weight:600; margin-bottom:6px">${msg}</div>
                            <div style="font-size:12px;color:var(--text-muted)">Posted: ${escapeHtml(created)} ${engaged ? '· Engaged users: ' + escapeHtml(String(engaged)) : ''}</div>`;
          out.appendChild(card);
        });

        if ((res.data || []).length === 0) {
          out.innerHTML += '<div class="note">No recent posts found — this Page may not have public posts. If you need a different Page for the review, please sign in with a Page that has recent posts.</div>';
        } else {
          setCaption('Posts displayed', 'The demo displayed recent Page posts and engagement metrics to demonstrate allowed usage of pages_read_engagement.');
        }
      });
    }

    // Utility: sanitize strings for safe insertion into innerHTML
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe).replace(/[&<"'>]/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m];
      });
    }

    // Called on page load: if already connected via fbAsyncInit, FB.getLoginStatus will trigger onFBConnected
    // Fallback: ensure caption shows helpful instruction if SDK fails to load
    window.addEventListener('load', function () {
      setTimeout(function () {
        if (typeof FB === 'undefined') {
          setCaption('Meta SDK not loaded', 'The Facebook SDK could not load in this environment. App Review requires showing the login dialog - ensure the SDK is permitted to load in your review environment.');
        }
      }, 1200);
    });
  </script>
</body>

</html>